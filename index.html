<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“å…­æ—¥éŠ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¨­å®šå­—é«”èˆ‡æ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .header-bg {
            /* å†°é›ªæ¼¸å±¤è‰² */
            background-image: linear-gradient(135deg, #2E4057 0%, #748DA6 100%); 
        }
        /* ä¸»å¼·èª¿è‰²ï¼šæ·±é’è—è‰² */
        .accent-color {
            color: #00A8A0; 
        }
        
        /* å°è¦½åˆ— Tab æ¨£å¼åŸºåº• */
        .tab-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }
        /* é ‚å±¤ Tab æ´»èºæ¨£å¼ */
        .main-tab.active {
            border-bottom-color: #00A8A0;
            color: #00A8A0;
            font-weight: 700;
            background-color: #fff;
        }
        /* æ¬¡å±¤ Day Tab æ´»èºæ¨£å¼ */
        .day-tab.active {
            border-bottom-color: #3C79D5; /* ä½¿ç”¨ä¸åŒçš„é¡è‰²å€åˆ†å±¤ç´š */
            color: #3C79D5;
            font-weight: 700;
            background-color: #f0f4f8;
        }

        .content-area {
            animation: fadeIn 0.4s ease-in-out;
            min-height: 500px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .meal-summary {
            background-color: #F8F9FA;
            border-left: 3px solid #748DA6;
        }
        /* éš±è—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* [æ–°å¢] Modal å½ˆçª—æ¨£å¼ */
        #location-modal {
            transition: opacity 0.2s ease-in-out;
        }
        #location-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #location-modal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* [æ–°å¢] åƒ…ç”¨æ–¼è©³ç´°è¡Œç¨‹çš„å¯é»æ“Šæ–‡å­—æ¨£å¼ (æ·±è—è‰²ã€æœ‰åº•ç·š) */
        .highlight-text-clickable {
            font-weight: 700;
            color: #0369a1; 
            background-color: #e0f2fe; 
            padding: 0 4px;
            border-radius: 2px;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: #7dd3fc;
            text-decoration-thickness: 2px;
        }
        
        /* [ä¿ç•™] åŸå§‹çš„é«˜äº®æ¨£å¼ (ç”¨æ–¼é¦–é æˆ–å…¶ä»–ä¸éœ€è¦é»æ“Šçš„åœ°æ–¹) */
        .highlight-text-static {
            font-weight: 700;
            color: #be185d; /* pink-700 */
            background-color: #fce7f3; /* pink-100 */
            padding: 0 4px;
            border-radius: 2px;
        }
        .location-text-static {
            font-weight: 700;
            color: #334155; /* slate-700 */
            background-color: #e2e8f0; /* slate-200 */
            padding: 0 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body class-name="p-0">

    <div id="app" class="max-w-6xl mx-auto bg-white shadow-2xl relative">
        
        <!-- [æ–°å¢] Modal åœ°é»å°å¡ (é è¨­éš±è—) -->
        <div id="location-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 relative transform transition-all scale-100">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-3 border-b pb-2 pr-8">åœ°é»åç¨±</h3>
                <div class="space-y-4">
                    <div class="flex items-start">
                        <span class="text-xl mr-3 mt-0.5">ğŸ“</span>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">åœ°å€</p>
                            <p id="modal-address" class="text-gray-700 text-sm leading-relaxed font-medium">åœ°å€è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <span class="text-xl mr-3 mt-0.5">ğŸ•’</span>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">ç‡Ÿæ¥­æ™‚é–“</p>
                            <p id="modal-hours" class="text-gray-700 text-sm leading-relaxed font-medium">ç‡Ÿæ¥­æ™‚é–“è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <button id="modal-map-btn" class="w-full bg-[#00A8A0] text-white py-2.5 rounded-lg font-bold hover:bg-[#008F87] transition flex items-center justify-center shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        é–‹å•Ÿ Google Maps
                    </button>
                </div>
            </div>
        </div>

        <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡è¦–è¦ºå€å¡Š (å°é¢æŠ¬é ­) -->
        <header class="header-bg p-6 sm:p-10 text-white text-center rounded-b-xl">
            <h1 class="text-3xl sm:text-4xl font-extrabold opacity-95 mb-2">
                âœˆï¸ 2026 å†¬å­£é™å®š | åŒ—æµ·é“å…­å¤©äº”å¤œä¹‹æ—…
            </h1>
            <p class="text-lg font-light tracking-widest">ç ´å†°èˆ¹ï¼é›ªä¸Šæ´»å‹•ï¼å°æ¨½æ•£ç­–</p>
        </header>

        <!-- å°è¦½åˆ—å®¹å™¨ (Sticky) -->
        <div class="sticky top-0 z-10 bg-white shadow-md">
            
            <!-- 1. é ‚å±¤ä¸»å°è¦½åˆ— (ä¸»é  | è©³ç´°è¡Œç¨‹) -->
            <div id="main-tabs" class="flex overflow-x-auto whitespace-nowrap px-4 sm:px-6 border-b border-gray-300">
                <!-- Tabs will be rendered here by JS -->
            </div>

            <!-- 2. æ¬¡å±¤æ—¥æœŸå°è¦½åˆ— (Day 1 - Day 6) -->
            <div id="day-tabs" class="flex overflow-x-auto whitespace-nowrap px-4 sm:px-6 border-b border-gray-200 bg-gray-50" style="display: none;">
                <!-- Day Tabs will be rendered here by JS -->
            </div>
        </div>

        <!-- å…§å®¹å€ - å‹•æ…‹åˆ‡æ›é¡¯ç¤ºä¸»é æˆ–æ¯æ—¥è¡Œç¨‹ -->
        <div id="dynamic-content" class="content-area bg-gray-50 px-4 sm:px-6">
            <!-- Content will be rendered here by JS -->
            <div class="text-center text-gray-500 py-16">
                è¼‰å…¥ä¸­... è«‹ç¨å€™æˆ–ç¢ºèªæ‚¨å·²é»æ“Š Preview æŒ‰éˆ•ã€‚
            </div>
        </div>

        <!-- åº•éƒ¨å‚™è¨» -->
        <footer class="header-bg p-4 text-center text-white text-sm mt-8">
            <p>â€» æœ¬è¡Œç¨‹ç‚ºå»ºè­°è‰ç¨¿ï¼Œè«‹ç•™æ„åœ–ç‰‡çš†ç‚ºç¤ºæ„åœ–ï¼Œå¯¦éš›é¤é£Ÿ/ä½å®¿ä»¥æœ€çµ‚è¡Œç¨‹ç‚ºæº–ã€‚</p>
        </footer>
    </div>

    <!-- è…³æœ¬å€åŸŸ (ä¿ç•™æ‰€æœ‰åŠŸèƒ½é‚è¼¯) -->
    <script>
        // --- API & ç’°å¢ƒè¨­å®š ---
        const apiKey = ""; 
        const API_KEY = apiKey || "AIzaSyCUAqeZHGu8dildmhdmOd_nTmoHa15EggU"; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const MAX_RETRIES = 5;
        const WEATHER_DISPLAY_ID = "weather-display-home"; 

        // --- API å‘¼å«é »ç‡é™åˆ¶è¨­å®š ---
        const RATE_LIMIT_MS = 43200000; 
        const LAST_RATE_UPDATE_KEY = 'lastExchangeRateUpdate';
        
        // --- åŒ¯ç‡ç›¸é—œå…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
        const FALLBACK_RATE = 0.22; 
        let currentExchangeRate = FALLBACK_RATE; 

        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let activeMainTab = 'home'; 
        let activeDayId = 'day-1'; 

        // --- è¡Œç¨‹è³‡æ–™ (å·²åŠ å…¥ address å’Œ hoursï¼Œä½†ä¿ç•™åŸå§‹çµæ§‹) ---
        const itineraryData = [
            {
                id: 1,
                title: "02/20ï¼šæœ­å¹Œå•Ÿç¨‹ âœˆï¸",
                subtitle: "ã€åˆè­˜æœ­å¹Œã€‘å¾æ©Ÿå ´ç›´å¥”å¸‚å€ï¼Œå±•é–‹æ‚ é–’çš„å†¬å­£æ¼«æ­¥ã€‚",
                location: "æœ­å¹Œ, æ—¥æœ¬", 
                details: [
                    { time: "04:00", description: "æ¡ƒåœ’æ©Ÿå ´ Terminal 1 è¾¦ç†å ±åˆ°æ‰‹çºŒèˆ‡è¡Œææ‰˜é‹ã€‚", query: "æ¡ƒåœ’æ©Ÿå ´ Terminal 1", address: "æ¡ƒåœ’å¸‚å¤§åœ’å€èˆªç«™å—è·¯15è™Ÿ", hours: "24å°æ™‚é–‹æ”¾" },
                    { time: "06:20", description: "æ­ä¹˜**è™èˆª IT 234** èˆªç­ (06:20) é£›å¾€åŒ—æµ·é“æ–°åƒæ­²æ©Ÿå ´ã€‚", query: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", address: "æ¡ƒåœ’å¸‚å¤§åœ’å€èˆªç«™å—è·¯15è™Ÿ", hours: "èˆªç­æ™‚é–“ä¾èˆªç©ºå…¬å¸å…¬å‘Š" },
                    { time: "10:55", description: "æŠµé”**åŒ—æµ·é“æ–°åƒæ­²æ©Ÿå ´**ï¼Œæº–å‚™è¾¦ç†å…¥å¢ƒæ‰‹çºŒ (å¹³å‡ç´„éœ€ 1 å°æ™‚)ã€‚", query: "æ–°åƒæ­²æ©Ÿå ´", address: "Bibi, Chitose, Hokkaido 066-0012, Japan", hours: "åœ‹å…§ç·š 6:20-23:00 / åœ‹éš›ç·š ä¾èˆªç­" },
                    { time: "12:00", description: "å…¥å¢ƒæ‰‹çºŒèˆ‡é ˜å–è¡Œæå®Œæˆå¾Œï¼Œæ­ä¹˜äº¤é€šå·¥å…·å‰å¾€æœ­å¹Œå¸‚å€ã€‚", query: "æ–°åƒæ­²æ©Ÿå ´", address: "Bibi, Chitose, Hokkaido 066-0012, Japan", hours: "JRå¿«é€ŸAirportè™Ÿæ¯12åˆ†é˜ä¸€ç­" },
                    { time: "15:00", description: "åƒè§€**å¤§é€šå…¬åœ’**åŠç¶“å…¸åœ°æ¨™**æœ­å¹Œé›»è¦–å¡”**ã€‚", query: "æœ­å¹Œå¤§é€šå…¬åœ’ æœ­å¹Œé›»è¦–å¡”", address: "æœ­å¹Œå¸‚ä¸­å¤®å€å¤§é€šè¥¿1ä¸ç›®", hours: "é›»è¦–å¡”å±•æœ›å°: 09:00-22:00 (æœ€å¾Œå…¥å ´ 21:50)" },
                    { time: "18:30", description: "åœ¨ç¾é£Ÿèˆ‡è³¼ç‰©å¤©å ‚**ç‹¸å°è·¯å•†åº—è¡—**è‡ªç”±æ´»å‹•ï¼Œäº«å—æ—¥å¼æ™šé¤ã€‚", query: "æœ­å¹Œç‹¸å°è·¯å•†åº—è¡—", address: "æœ­å¹Œå¸‚ä¸­å¤®å€å—2ãƒ»3æ¢è¥¿1ï½7ä¸ç›®", hours: "å¤§éƒ¨åˆ†åº—å®¶ 10:00-20:00 (é¤å»³è‡³è¼ƒæ™š)" }
                ],
                breakfast: "æº«æš–çš„å®¶ / æ©Ÿä¸Šè‡ªç†",
                lunch: "æ©Ÿå ´è‡ªç†",
                dinner: "ç‹¸å°è·¯è‡ªç†",
                lodging: "æœ­å¹Œå¸‚å€é£¯åº—",
            },
            {
                id: 2,
                title: "02/21ï¼šä¼éµï¼é›ªä¸Šæ´»å‹•ï¼æº«æ³‰ ğŸ§",
                subtitle: "ã€å†°é›ªæ¨‚åœ’ã€‘æ•´æ—¥ç²¾å½©æ´»å‹•ï¼Œä»¥æº«æ³‰è§£é™¤ç–²å‹ã€‚",
                warning: "åœ˜é«”å·´å£«è¡Œç¨‹ï¼š07:40JRæœ­å¹ŒåŒ—å£é›†åˆï¼Œæ¯äººé™å¸¶ä¸€ä»¶å¤§å‹è¡Œæã€‚<br>âš ï¸ æ—¥æœ¬å¸æ©Ÿå·¥æ™‚æ§ç®¡åš´æ ¼,åˆ‡å‹¿é²åˆ°, ä»¥å…è¢«ä¸ŸåŒ…",
                location: "æ—­å·, æ—¥æœ¬", 
                details: [
                    { time: "08:00", description: "æ­ä¹˜å°ˆå±¬å·´å£«å‰å¾€**æ—­å±±å‹•ç‰©åœ’**ï¼Œè§€è³å†¬å­£é™å®šçš„ä¼éµæ•£æ­¥ã€‚", query: "æ—­å±±å‹•ç‰©åœ’", address: "åŒ—æµ·é“æ—­å·å¸‚æ±æ—­å·ç”ºå€‰æ²¼", hours: "å†¬å­£é–‹åœ’: 10:30-15:30 (ä¼éµæ•£æ­¥ç´„11:00/14:30)" },
                    { time: "12:00", description: "åˆé¤æ™‚é–“ (ç„—çƒ¤èƒèŸ¹æµ·é®®é™¶æ¿ç‡’å¾¡è†³)ã€‚", query: "æ—­å·åˆé¤åœ°é»", address: "æ—­å·å¸‚å€ / å‹•ç‰©åœ’å‘¨é‚Š", hours: "åˆé¤æ™‚æ®µ" },
                    { time: "14:00", description: "å‰å¾€é›ªä¸Šæ¨‚åœ’ï¼Œé«”é©—é›ªä¸Šæ‘©æ‰˜è»Šã€é›ªç›†ã€æ©¡çš®è‰‡ç­‰**åˆºæ¿€é›ªä¸Šæ´»å‹•**ã€‚", query: "åŒ—æµ·é“é›ªä¸Šæ¨‚åœ’", address: "åŒ—æµ·é“ä¸Šå·éƒ¡æ¯”å¸ƒç”ºåŒ—7ç·š17è™Ÿ (æ¯”å¸ƒæ»‘é›ªå ´å‘¨é‚Š)", hours: "å†¬å­£é–‹æ”¾ 09:00-16:00" },
                    { time: "18:00", description: "å°ˆè»Šå‰å¾€**å±¤é›²å³½æº«æ³‰å€**ï¼Œäº«å—é£¯åº—å…§è±ªè¯æ™šé¤åŠæº«æ³‰ã€‚", query: "å±¤é›²å³½æº«æ³‰é£¯åº—", address: "åŒ—æµ·é“ä¸Šå·éƒ¡ä¸Šå·ç”ºå±¤é›²å³¡", hours: "å…¥ä½æ™‚é–“é€šå¸¸ç‚º 15:00 å¾Œ" }
                ],
                breakfast: "é£¯åº—å…§æ—©é¤",
                lunch: "ç„—çƒ¤èƒèŸ¹æµ·é®®é™¶æ¿ç‡’å¾¡è†³",
                dinner: "æº«æ³‰é£¯åº—è±ªè¯æ™šé¤",
                lodging: "**å±¤é›²å³½å‘¨é‚Šæº«æ³‰é£¯åº—**",
            },
            {
                id: 3,
                title: "02/22ï¼šç´‹åˆ¥ç ´å†°èˆ¹ï¼é…’é€ å·¡ç¦® ğŸš¢",
                subtitle: "ã€æµ·ä¹‹éœ‡æ’¼ã€‘æ¬£è³é„‚éœæ¬¡å…‹æµ·çš„æµå†°å¥‡æ™¯ã€‚",
                warning: "âš ï¸ åœ˜é«”å·´å£«è¡Œç¨‹ï¼šç´„ 18:00-19:00 è¿”æŠµ JR æœ­å¹Œè»Šç«™è§£æ•£",
                location: "ç´‹åˆ¥, æ—¥æœ¬", 
                details: [
                    { time: "08:30", description: "åƒè§€**éŠ€æ²³æµæ˜Ÿç€‘å¸ƒ** (å†¬å­£æ™¯è§€)ã€‚", query: "éŠ€æ²³æµæ˜Ÿç€‘å¸ƒ", address: "åŒ—æµ·é“ä¸Šå·éƒ¡ä¸Šå·ç”ºå±¤é›²å³¡", hours: "å…¨å¤©é–‹æ”¾ (å†¬å­£éœ€æ³¨æ„é™¤é›ªç‹€æ³)" },
                    { time: "10:30", description: "é‡é ­æˆ²ï¼šæŠµé”ç´‹åˆ¥ï¼Œæ­ä¹˜**ç ´å†°èˆ¹** (GARINKO è™Ÿ) é«”é©—ç ´å†°ã€‚", query: "ç´‹åˆ¥ GARINKO è™Ÿ ç ´å†°èˆ¹", address: "åŒ—æµ·é“ç´‹åˆ¥å¸‚æµ·æ´‹å…¬åœ’1ç•ªåœ°", hours: "å†¬å­£å‡ºèˆª: 09:00 / 10:30 / 12:00 / 13:30 / 15:00" },
                    { time: "12:30", description: "è±ªè¯èŸ¹è…³å¹²è²ç«¯çˆç‡’å¥—é¤åˆé¤ã€‚", query: "ç´‹åˆ¥æµ·é®®é¤å»³", address: "ç´‹åˆ¥å¸‚æµ·æ´‹å…¬åœ’å‘¨é‚Š", hours: "åˆé¤æ™‚æ®µ" },
                    { time: "14:30", description: "æ–‡åŒ–é«”é©—ï¼šåƒè§€**æ—­å·ç”·å±±é…’é€ **ï¼Œäº†è§£æ¸…é…’é‡€è£½éç¨‹ã€‚", query: "æ—­å·ç”·å±±é…’é€ ", address: "åŒ—æµ·é“æ—­å·å¸‚æ°¸å±±2æ¢7ä¸ç›®1-33", hours: "09:00-17:00 (å…è²»åƒè§€)" },
                    { time: "18:00", description: "è¿”å›æœ­å¹Œå¸‚å€é£¯åº—è¾¦ç†å…¥ä½ï¼Œæ™šé¤è‡ªç†ã€‚", query: "æœ­å¹Œå¸‚å€é£¯åº—", address: "æœ­å¹Œå¸‚ä¸­å¿ƒ", hours: "å…¥ä½æ™‚é–“é€šå¸¸ç‚º 15:00 å¾Œ" }
                ],
                breakfast: "é£¯åº—å…§æ—©é¤",
                lunch: "è±ªè¯èŸ¹è…³å¹²è²ç«¯çˆç‡’å¥—é¤",
                dinner: "æœ­å¹Œå¸‚å€è‡ªç†",
                lodging: "æœ­å¹Œè’™ç‰¹åˆ©åŸƒå¾·çˆ¾éœå¤«é…’åº—",
            },
            {
                id: 4,
                title: "02/23ï¼šå°æ¨½é‹æ²³ï¼éŸ³æ¨‚ç›’å ‚ ğŸ””",
                subtitle: "ã€è‡ªç”±æ•£ç­–ã€‘æ­ä¹˜ JR å‰å¾€ï¼Œç›¡æƒ…äº«å—å°æ¨½çš„æµªæ¼«æ°›åœã€‚",
                location: "å°æ¨½, æ—¥æœ¬", 
                details: [
                    { time: "10:00", description: "å¾æœ­å¹Œæ­ä¹˜ JR å‰å¾€å°æ¨½ã€‚", query: "å°æ¨½ JR ç«™", address: "å°æ¨½å¸‚ç¨»ç©—2ä¸ç›®", hours: "05:30-23:30" },
                    { time: "11:00", description: "**å°æ¨½é‹æ²³**ï¼šæ²¿è‘—é‹æ²³é‚Šæ•£æ­¥ï¼Œæ‹æ”ç¶“å…¸å€‰åº«ç¾¤ã€‚", query: "å°æ¨½é‹æ²³", address: "åŒ—æµ·é“å°æ¨½å¸‚æ¸¯ç”º", hours: "å…¨å¤©é–‹æ”¾ (é‹æ²³éŠèˆ¹ä¾å­£ç¯€)" },
                    { time: "12:30", description: "åˆé¤ï¼šå°æ¨½å£½å¸æˆ–è‡ªç†ã€‚", query: "å°æ¨½å£½å¸åº—", address: "å°æ¨½å£½å¸é€š (æ”¿å£½å¸/æ—­å£½å¸ç­‰)", hours: "ç´„ 11:00-21:00" },
                    { time: "14:00", description: "åƒè§€**åŒ—ä¸€ç¡å­é¤¨**èˆ‡**éŸ³æ¨‚ç›’åšç‰©é¤¨**ï¼Œæ„Ÿå—æ‡·èˆŠæ°£æ¯ã€‚", query: "å°æ¨½éŸ³æ¨‚ç›’åšç‰©é¤¨ åŒ—ä¸€ç¡å­é¤¨", address: "å°æ¨½å¸‚ä½å‰ç”º4-1 (éŸ³æ¨‚ç›’å ‚æœ¬é¤¨)", hours: "09:00-18:00" },
                    { time: "16:00", description: "åˆ¥å¿˜äº†åœ¨ **LeTAO ç¸½åº—**äº«å—ä¸‹åˆèŒ¶ã€‚", query: "å°æ¨½ LeTAO ç¸½åº—", address: "åŒ—æµ·é“å°æ¨½å¸‚å ºç”º7-16", hours: "09:00-18:00 (2F å’–å•¡å»³è‡³ 17:30)" },
                    { time: "18:30", description: "æ™šé¤ï¼šè¿”å›æœ­å¹Œå¾Œï¼Œå»ºè­°å‰å¾€æœ­å¹Œæ‹‰éºµå…±å’Œåœ‹ (è‡ªç†)ã€‚", query: "æœ­å¹Œæ‹‰éºµå…±å’Œåœ‹", address: "æœ­å¹Œå¸‚ä¸­å¤®å€åŒ—5æ¢è¥¿2ä¸ç›® ESTA 10F (æˆ–å‘¨é‚Š)", hours: "11:00-22:00" }
                ],
                breakfast: "é£¯åº—å…§æ—©é¤",
                lunch: "å°æ¨½å£½å¸æˆ–è‡ªç†",
                dinner: "æœ­å¹Œæ‹‰éºµå…±å’Œåœ‹ (è‡ªç†)",
                lodging: "æœ­å¹Œè’™ç‰¹åˆ©åŸƒå¾·çˆ¾éœå¤«é…’åº—",
            },
            {
                id: 5,
                title: "02/24ï¼šæµ·é®®è³¼ç‰©ï¼ä¸‰å¤§èŸ¹å®´ ğŸ›ï¸",
                subtitle: "ã€ç¾é£Ÿå¤©å ‚ã€‘ä¸€æ•´å¤©ç»çµ¦åŒ—æµ·é“çš„ç¾å‘³èˆ‡è³¼ç‰©ã€‚",
                location: "æœ­å¹Œ, æ—¥æœ¬", 
                details: [
                    { time: "09:30", description: "ä¸Šåˆï¼šåƒæ‹œ**åŒ—æµ·é“ç¥å®®**ã€‚", query: "åŒ—æµ·é“ç¥å®®", address: "åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€å®®ä¸˜474", hours: "å†¬å­£: 07:00-16:00" },
                    { time: "11:00", description: "å‰å¾€**æœ­å¹Œå ´å¤–å¸‚å ´**ï¼Œäº«ç”¨è¶…æ–°é®®æµ·é®®ä¸¼ (è‡ªç†)ã€‚", query: "æœ­å¹Œå ´å¤–å¸‚å ´", address: "æœ­å¹Œå¸‚ä¸­å¤®å€åŒ—11æ¢è¥¿21ä¸ç›®", hours: "06:00-17:00 (é¤å»³ç´„ 07:00 é–‹å§‹)" },
                    { time: "14:00", description: "ä¸‹åˆï¼šåœ¨**ç‹¸å°è·¯å•†åº—è¡—**æˆ–**å¤§é€šå…¬åœ’**å‘¨é‚Šé€²è¡Œè£œè²¨è³¼ç‰©ã€‚", query: "ç‹¸å°è·¯å•†åº—è¡— å¤§é€šå…¬åœ’", address: "æœ­å¹Œå¸‚ä¸­å¤®å€", hours: "å…¨å¤©é–‹æ”¾ (å•†åº—å„ç•°)" },
                    { time: "19:00", description: "æ™šé¤ï¼šå»ºè­°äº«å—ç¶“å…¸çš„**ä¸‰å¤§èŸ¹åƒåˆ°é£½** (å¸ç‹èŸ¹ã€æ¾è‘‰èŸ¹ã€æ¯›èŸ¹) (è‡ªç†)ã€‚", query: "æœ­å¹Œä¸‰å¤§èŸ¹åƒåˆ°é£½", address: "æœ­å¹Œå¸‚å€ (å¦‚é›£é™€ Nanda)", hours: "æ™šé¤æ™‚æ®µé€šå¸¸ 17:00-22:00" }
                ],
                breakfast: "é£¯åº—å…§æ—©é¤",
                lunch: "å ´å¤–å¸‚å ´æµ·é®®ä¸¼ (è‡ªç†)",
                dinner: "ä¸‰å¤§èŸ¹åƒåˆ°é£½ (è‡ªç†)",
                lodging: "æœ­å¹Œè’™ç‰¹åˆ©åŸƒå¾·çˆ¾éœå¤«é…’åº—",
            },
            {
                id: 6,
                title: "02/25ï¼šæœ€çµ‚æ¡è²·ï¼è¿”å®¶ ğŸ ",
                subtitle: "ã€å®Œç¾å¥é»ã€‘è¼•é¬†è¡€æ‹šå¾Œï¼Œå¸¶è‘—æ»¿æ»¿å›æ†¶è¸ä¸Šæ­¸é€”ã€‚",
                location: "æ–°åƒæ­²æ©Ÿå ´, æ—¥æœ¬", 
                details: [
                    { time: "10:00", description: "é€€æˆ¿å¾Œï¼Œå‰å¾€**ä¸‰äº•OUTLETè³¼ç‰©ä¸­å¿ƒ**æˆ– Rera Outletã€‚", query: "æœ­å¹Œä¸‰äº•OUTLETè³¼ç‰©ä¸­å¿ƒ", address: "åŒ—æµ·é“åŒ—å»£å³¶å¸‚å¤§æ›²å¹¸ç”º3-7-6", hours: "10:00-20:00" },
                    { time: "12:00", description: "åœ¨ OUTLET å…§äº«ç”¨åˆé¤ã€‚", query: "OUTLET é¤å»³", address: "Outlet ç¾é£Ÿè¡—", hours: "10:30-21:00" },
                    { time: "13:30", description: "é›†åˆå‰å¾€æ–°åƒæ­²æ©Ÿå ´ã€‚", query: "æ–°åƒæ­²æ©Ÿå ´", address: "Bibi, Chitose, Hokkaido", hours: "24å°æ™‚é–‹æ”¾" },
                    { time: "14:40", description: "æ­ä¹˜è¯èˆª CI 131 ç­æ©Ÿè¿”å›å°åŒ—ã€‚", query: "æ–°åƒæ­²æ©Ÿå ´", address: "åœ‹éš›ç·šèˆªå»ˆ", hours: "èˆªç­æ™‚é–“" }
                ],
                breakfast: "é£¯åº—å…§æ—©é¤",
                lunch: "OUTLET ç°¡é¤ (è‡ªç†)",
                dinner: "æ©Ÿä¸Šç°¡é¤",
                lodging: "æº«æš–çš„å®¶",
            },
        ];

        const mainTabsContainer = document.getElementById('main-tabs');
        const dayTabsContainer = document.getElementById('day-tabs');
        const contentContainer = document.getElementById('dynamic-content');
        const locationModal = document.getElementById('location-modal');
        
        // --- æ ¸å¿ƒå·¥å…·å‡½å¼ (ç¶­æŒåŸç‰ˆ) ---
        
        async function fetchWithRetry(url, options) {
            let delay = 1000;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        if (i < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                    }
                    return response;
                } catch (error) {
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                    throw error; 
                }
            }
        }
        
        function isRateLimited() {
            const lastUpdateStr = localStorage.getItem(LAST_RATE_UPDATE_KEY);
            if (!lastUpdateStr) return null;
            const lastUpdateTime = parseInt(lastUpdateStr, 10);
            const currentTime = new Date().getTime();
            const elapsedTime = currentTime - lastUpdateTime;
            if (elapsedTime < RATE_LIMIT_MS) return RATE_LIMIT_MS - elapsedTime;
            return null;
        }

        function updateRateLimitTimestamp() {
            localStorage.setItem(LAST_RATE_UPDATE_KEY, new Date().getTime().toString());
        }

        // --- Modal é‚è¼¯ (æ–°å¢) ---
        
        window.openModal = function(title, address, hours, query) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-address').textContent = address;
            document.getElementById('modal-hours').textContent = hours;
            
            const mapBtn = document.getElementById('modal-map-btn');
            mapBtn.onclick = function() {
                window.openInGoogleMaps(query);
            };
            
            locationModal.classList.remove('hidden');
        };

        window.closeModal = function() {
            locationModal.classList.add('hidden');
        };

        locationModal.addEventListener('click', function(e) {
            if (e.target === locationModal) closeModal();
        });

        window.openInGoogleMaps = function(query) {
            if (query) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank'); 
            }
        }

        // --- é—œéµå­—èˆ‡é«˜äº® (ä¿®æ”¹ç‚ºæ”¯æ´ Modal) ---
        const ACTION_KEYWORDS = [
            "è™èˆª IT 234", "è¯èˆª CI 131", "åˆºæ¿€é›ªä¸Šæ´»å‹•", 
            "ç ´å†°èˆ¹", "ä¸‰å¤§èŸ¹åƒåˆ°é£½", "æ—­å±±å‹•ç‰©åœ’", "å°æ¨½é‹æ²³", "LeTAO ç¸½åº—", 
            "æœ­å¹Œé›»è¦–å¡”", "ç‹¸å°è·¯å•†åº—è¡—", "éŠ€æ²³æµæ˜Ÿç€‘å¸ƒ", "æ—­å·ç”·å±±é…’é€ ", 
            "åŒ—ä¸€ç¡å­é¤¨", "éŸ³æ¨‚ç›’åšç‰©é¤¨", "åŒ—æµ·é“ç¥å®®", "æœ­å¹Œå ´å¤–å¸‚å ´", "ä¸‰äº•OUTLETè³¼ç‰©ä¸­å¿ƒ"
        ];
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ  isClickable åƒæ•¸ï¼Œæ±ºå®šæ˜¯å¦è¦å•Ÿç”¨ Modal åŠŸèƒ½
        const highlightText = (text, item, isClickable = false) => {
            // å®šç¾©é¡è‰²ï¼šé¦–é çš„ static (pink/slate) vs è©³ç´°é çš„ clickable (blue)
            const staticActionClass = "font-bold text-pink-700 bg-pink-100 px-1 rounded-sm";
            const staticLocationClass = "font-bold text-slate-700 bg-slate-200 px-1 rounded-sm";
            const clickableClass = "highlight-text-clickable"; // é€™æ˜¯æˆ‘å€‘å‰›å®šç¾©çš„æ¨£å¼

            return text.replace(/\*\*(.*?)\*\*/g, (match, p1) => {
                if (isClickable && item) {
                    // å¦‚æœå…è¨±é»æ“Šï¼Œä¸”æœ‰è³‡æ–™ï¼Œä½¿ç”¨ Modal æ¨¡å¼
                    const safeTitle = p1.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeAddress = (item.address || "åœ°å€è©³æƒ…è«‹æŸ¥è©¢").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeHours = (item.hours || "ç‡Ÿæ¥­æ™‚é–“è«‹æŸ¥è©¢").replace(/"/g, '&quot;');
                    const safeQuery = (item.query || p1).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    return `<span class="${clickableClass}" onclick="openModal('${safeTitle}', '${safeAddress}', '${safeHours}', '${safeQuery}')">${p1}</span>`;
                } else {
                    // å¦å‰‡ç¶­æŒåŸæ¨£ (é¦–é æ¨¡å¼)
                    const isAction = ACTION_KEYWORDS.some(keyword => p1.includes(keyword));
                    const className = isAction ? staticActionClass : staticLocationClass;
                    return `<span class="${className}">${p1}</span>`;
                }
            });
        };

        // --- åŠŸèƒ½å‡½å¼ (Weather, Exchange, Render) ---
        // é€™äº›å‡½å¼å®Œå…¨ä¿ç•™åŸç‰ˆé‚è¼¯ï¼Œåªåœ¨ renderDayContent ä½¿ç”¨æ–°çš„ highlightText æ¨¡å¼

        async function fetchWeather(userQuery, locationName, weatherDisplayId) {
            const resultContainer = document.getElementById('weather-result');
            const lastUpdatedContainer = document.getElementById('weather-last-updated');
            if (!resultContainer || !lastUpdatedContainer) return;

            const loadingHtml = `<div class="flex items-center text-sm text-gray-500 animate-pulse mt-2"><svg class="animate-spin h-4 w-4 mr-2 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>æ­£åœ¨æŸ¥è©¢ ${locationName} çš„å³æ™‚å¤©æ°£...</div>`;
            resultContainer.innerHTML = loadingHtml;
            lastUpdatedContainer.textContent = 'æ›´æ–°ä¸­...';

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: "You are a concise weather reporter. Your response must be a single, short sentence in Traditional Chinese, summarizing the temperature, high/low, and weather condition for the requested location based on the provided search results. If the data is unavailable, state it clearly. Do not use markdown formatting in the output." }]
                },
            };

            try {
                const response = await fetchWithRetry(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Call failed (Status: ${response.status})`);
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || `ç„¡æ³•å–å¾— ${locationName} çš„å¤©æ°£è³‡è¨Šï¼Œè«‹å˜—è©¦é‡æ–°æ•´ç†ã€‚`;
                resultContainer.innerHTML = `<div class="flex items-start mt-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 text-sky-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.975 4 4 0 10-7.432-1.761l-1.63 1.63a.1.1 0 01-.108.025l-2.923-1.125A3 3 0 003 15z" /></svg><p class="text-sm text-gray-800 font-medium">${generatedText}</p></div>`;
                lastUpdatedContainer.textContent = `ä¸Šæ¬¡æ›´æ–°æ™‚é–“: ${new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}`;
            } catch (error) {
                console.error("Error fetching weather:", error);
                resultContainer.innerHTML = `<div class="flex items-start text-sm text-red-600 mt-2 p-2 bg-red-50 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p>å¤©æ°£æŸ¥è©¢å¤±æ•—ï¼š${error.message}</p></div>`;
                lastUpdatedContainer.textContent = 'æ›´æ–°å¤±æ•—';
            }
        }

        function fallbackToTaipei(weatherDisplay, fallbackCity, reason = "å› ç³»çµ±ç’°å¢ƒé™åˆ¶ï¼Œç„¡æ³•å–å¾—æ‚¨çš„å³æ™‚ä½ç½®") {
            const userQuery = `What is the current temperature, condition (e.g., cloudy, snowy), and expected high/low temperature for ${fallbackCity}? Summarize in one sentence in Traditional Chinese.`;
            weatherDisplay.innerHTML = `<div class="flex items-start text-sm text-yellow-600 mb-2 p-2 bg-yellow-50 rounded-lg border border-yellow-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z" /></svg><p>${reason} (å·²å›é€€è‡³æŸ¥è©¢ <span class="font-bold">${fallbackCity}</span> å¤©æ°£)ã€‚</p></div><div id="weather-result"></div>`;
            fetchWeather(userQuery, fallbackCity, WEATHER_DISPLAY_ID);
        }

        function getDynamicWeather() {
            const weatherDisplay = document.getElementById(WEATHER_DISPLAY_ID);
            const fallbackCity = "å°åŒ—";
            weatherDisplay.innerHTML = `<div id="weather-result"></div><p id="weather-last-updated" class="text-xs text-right text-gray-400 mt-2">...</p>`;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const userQuery = `What is the current temperature, condition (e.g., cloudy, snowy), and expected high/low temperature for the location near latitude ${latitude} and longitude ${longitude}? Summarize in one sentence in Traditional Chinese.`;
                        weatherDisplay.querySelector('#weather-result').innerHTML = ``; 
                        fetchWeather(userQuery, "æ‚¨ç›®å‰çš„ä½ç½®", WEATHER_DISPLAY_ID);
                    },
                    (error) => {
                        console.warn("Geolocation failed:", error.message);
                        let reason = "å› ç³»çµ±ç’°å¢ƒé™åˆ¶ï¼Œç„¡æ³•å–å¾—æ‚¨çš„å³æ™‚ä½ç½®";
                        fallbackToTaipei(weatherDisplay, fallbackCity, reason);
                    },
                    { timeout: 3000 }
                );
            } else {
                fallbackToTaipei(weatherDisplay, fallbackCity, "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
            }
        }

        window.convertCurrency = function() {
            const jpyInput = document.getElementById('jpy-input');
            const twdOutput = document.getElementById('twd-output');
            if (!jpyInput || !twdOutput) return;
            let inputValue = jpyInput.value;
            if (inputValue.startsWith('-')) { jpyInput.value = inputValue.slice(1); inputValue = jpyInput.value; }
            const parts = inputValue.split('.');
            let integerPart = parts[0];
            if (integerPart.length > 6) { integerPart = integerPart.substring(0, 6); jpyInput.value = parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart; }
            const jpyAmount = parseFloat(jpyInput.value); 
            if (currentExchangeRate <= 0) { twdOutput.textContent = 'åŒ¯ç‡ç„¡æ•ˆï¼Œè«‹é»æ“Šã€Œé‡æ–°æ•´ç†ã€'; twdOutput.className = twdOutput.className.replace(/text-pink-700|bg-pink-100|border-pink-300|text-gray-700|bg-gray-100|border-gray-300|text-red-700|bg-red-100/g, 'text-red-700 bg-red-100 border-red-300'); return; }
            if (isNaN(jpyAmount) || jpyAmount <= 0) { twdOutput.textContent = '0 TWD'; twdOutput.className = twdOutput.className.replace(/text-red-700|bg-red-100|border-red-300|text-pink-700|bg-pink-100|border-pink-300/g, 'text-gray-700 bg-gray-100 border-gray-300'); return; }
            const twdAmount = Math.round(jpyAmount * currentExchangeRate); 
            twdOutput.textContent = `${twdAmount.toLocaleString('en-US')} TWD`;
            twdOutput.className = twdOutput.className.replace(/text-red-700|bg-red-100|border-red-300|text-gray-700|bg-gray-100|border-gray-300/g, 'text-pink-700 bg-pink-100 border-pink-300');
        }

        function renderRateLimitedStatus(minutes, rate) {
            return `<div class="text-right text-red-700 flex items-center justify-end space-x-2"><div class="text-xs font-normal"><p>ç›®å‰ä½¿ç”¨ä¸Šæ¬¡åŒ¯ç‡ï¼š1 JPY â‰ˆ ${rate} TWD</p></div><button class="inline-flex items-center justify-center text-gray-400 p-0.5 rounded-full bg-gray-50 cursor-not-allowed flex-shrink-0" title="é‡æ–°æ•´ç†é »ç‡é™åˆ¶ä¸­" disabled><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M3 13a9 9 0 1 0 3-7.7L3 8"/></svg></button></div>`;
        }

        function initializeExchangeRateStatus() {
            const statusDisplay = document.getElementById('current-rate-status');
            if (statusDisplay) { 
                statusDisplay.innerHTML = `<div class="text-xs text-gray-500 flex items-center justify-end space-x-1"><svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>è¼‰å…¥ä¸­... æº–å‚™æŸ¥è©¢åŒ¯ç‡</span><span class="w-5 h-5"></span></div>`;
                statusDisplay.className = 'mt-2 pt-1 flex justify-end';
            }
        }

        async function fetchExchangeRate() {
            const statusDisplay = document.getElementById('current-rate-status');
            const twdOutput = document.getElementById('twd-output');
            if (!statusDisplay || !twdOutput) return;

            const remainingTime = isRateLimited();
            if (remainingTime !== null) {
                const minutes = Math.ceil(remainingTime / 60000); 
                currentExchangeRate = FALLBACK_RATE; 
                convertCurrency();
                statusDisplay.innerHTML = renderRateLimitedStatus(minutes, currentExchangeRate.toFixed(4));
                statusDisplay.className = 'mt-2 pt-1 border-t border-gray-100 flex justify-end';
                twdOutput.className = twdOutput.className.replace(/text-pink-700|bg-pink-100|border-pink-300|text-gray-700|bg-gray-100|border-gray-300/g, 'text-red-700 bg-red-100 border-red-300');
                return; 
            }

            statusDisplay.innerHTML = `<div class="text-xs text-gray-700 flex items-center justify-end space-x-1 animate-pulse"><svg class="animate-spin h-3 w-3 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>æ­£åœ¨æŸ¥è©¢å³æ™‚åŒ¯ç‡ (é€é Google Search)</span><span class="w-5 h-5"></span></div>`;
            statusDisplay.className = 'mt-2 pt-1 border-t border-gray-100 flex justify-end'; 
            
            const rateQuery = "What is the current exchange rate for 1 Japanese Yen (JPY) in New Taiwan Dollars (TWD)?";
            const ratePayload = {
                contents: [{ parts: [{ text: rateQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: "You are an accurate financial assistant. Find the current exchange rate for JPY to TWD. Your response must contain ONLY the numeric value, rounded to 4 decimal places. Do not include currency symbols, text, or explanations." }] },
            };

            let success = false;
            let parsedRate = null;

            try {
                const response = await fetchWithRetry(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ratePayload)
                });
                if (!response.ok) throw new Error(`Gemini API call failed with status: ${response.status}`);
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (generatedText) {
                    const match = generatedText.match(/(\d+\.\d+)/);
                    if (match && match[1]) {
                        const rate = parseFloat(match[1]);
                        if (rate > 0.1 && rate < 0.3) { parsedRate = rate; success = true; } 
                    }
                }
            } catch (error) { console.error("Error fetching exchange rate:", error); }

            if (success) {
                updateRateLimitTimestamp(); 
                currentExchangeRate = parsedRate; 
                convertCurrency(); 
                statusDisplay.innerHTML = `<div class="text-right flex items-center justify-end space-x-2"><div class="text-xs font-normal text-gray-500"><p class="font-bold text-pink-700 leading-tight">1 JPY = ${currentExchangeRate.toFixed(4)} TWD</p><p class="mt-0.5">æ•¸æ“šä¾†æº: å³æ™‚ç¶²è·¯æŸ¥è©¢</p></div><button onclick="fetchExchangeRate()" class="inline-flex items-center justify-center text-gray-500 hover:text-gray-700 p-0.5 rounded-full hover:bg-gray-100 transition duration-150 flex-shrink-0" title="é‡æ–°æ•´ç†åŒ¯ç‡"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M3 13a9 9 0 1 0 3-7.7L3 8"/></svg></button></div>`;
            } else {
                currentExchangeRate = FALLBACK_RATE;
                convertCurrency(); 
                statusDisplay.innerHTML = `<div class="text-right text-red-600 flex items-center justify-end space-x-2"><div class="text-xs font-normal"><p>å³æ™‚åŒ¯ç‡æŸ¥è©¢å¤±æ•— (API éŒ¯èª¤æˆ–ç¶²è·¯å•é¡Œ)ã€‚</p><p class="font-bold leading-tight">ç›®å‰ä½¿ç”¨é è¨­åŒ¯ç‡ï¼š1 JPY â‰ˆ ${FALLBACK_RATE.toFixed(4)} TWD</p></div><button onclick="fetchExchangeRate()" class="inline-flex items-center justify-center text-gray-500 hover:text-gray-700 p-0.5 rounded-full hover:bg-gray-100 transition duration-150 flex-shrink-0" title="é‡æ–°æ•´ç†åŒ¯ç‡"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M3 13a9 9 0 1 0 3-7.7L3 8"/></svg></button></div>`;
            }
            statusDisplay.className = 'mt-2 pt-1 border-t border-gray-100 flex justify-end'; 
        }

        function renderCurrentWeatherBlock() {
            return `
                <div class="p-4 bg-sky-50 rounded-xl border border-sky-200 mb-6 shadow-sm">
                    <h3 class="text-xl font-bold text-sky-700 mb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        ç•¶å‰æ‰€åœ¨åœ°å³æ™‚å¤©æ°£
                    </h3>
                    <div id="${WEATHER_DISPLAY_ID}" class="mt-2">
                        <div id="weather-result">
                            <div class="text-sm text-gray-500 flex items-center">
                                <svg class="animate-spin h-4 w-4 mr-2 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                æ­£åœ¨æª¢æŸ¥å®šä½æ¬Šé™ä¸¦æº–å‚™æŸ¥è©¢å¤©æ°£...
                            </div>
                        </div>
                        <p id="weather-last-updated" class="text-xs text-right text-gray-400 mt-2">...</p>
                    </div>
                </div>
            `;
        }

        function renderExchangeRateBlock() {
            return `
                <div id="exchange-rate-block" class="max-w-xs mx-auto p-2 my-2 bg-transparent">
                    <p class="text-sm font-semibold text-gray-600 mb-2 text-center">ğŸ’µ JPY â‡Œ TWD å¿«é€Ÿè©¦ç®—</p>
                    <div class="flex space-x-2">
                        <div class="flex-1"><input type="number" id="jpy-input" oninput="convertCurrency()" placeholder="æ—¥å¹£é‡‘é¡ (JPY)" class="w-full py-2 px-3 border border-gray-300 rounded-lg text-sm shadow-sm focus:ring-sky-500 focus:border-sky-500" min="0" max="999999"></div>
                        <div id="twd-output" class="flex-1 flex items-center justify-end py-2 px-3 border border-gray-300 rounded-lg bg-gray-100 text-sm font-bold text-gray-700 text-right shadow-inner">0 TWD</div>
                    </div>
                    <div id="current-rate-status" class="mt-2 pt-1 flex justify-end"></div>
                </div>
            `;
        }

        function renderHomeContent() {
            const highlightsContent = `
                <div>
                    <h3 class="text-2xl font-bold accent-color mb-3 border-b pb-2">ğŸ¯ è¡Œç¨‹äº®é»</h3>
                    <p class="text-gray-600 mb-6 italic">æœ¬æ¬¡è¡Œç¨‹å°ˆç‚ºå†¬å­£è¨­è¨ˆï¼Œçµåˆäº†åŒ—æµ·é“æœ€ç¶“å…¸çš„é›ªåœ‹é«”é©—ã€ç¾é£Ÿèˆ‡æ·±åº¦æ–‡åŒ–ã€‚</p>
                    <ul class="space-y-3 pl-4 list-disc text-gray-700">
                        <li><strong class="text-sky-700">é›ªåœ°å¥‡è§€ï¼š</strong>æ­ä¹˜ç´‹åˆ¥${highlightText('**ç ´å†°èˆ¹**', {}, false)}ï¼Œè¿‘è·é›¢æ„Ÿå—é„‚éœæ¬¡å…‹æµ·çš„æµå†°éœ‡æ’¼ã€‚</li>
                        <li><strong class="text-sky-700">å‹•ç‰©æ˜æ˜Ÿï¼š</strong>å‰å¾€${highlightText('**æ—­å±±å‹•ç‰©åœ’**', {}, false)}ï¼Œè§€è³å†¬å­£é™å®šçš„ä¼éµé›ªåœ°æ•£æ­¥ã€‚</li>
                        <li><strong class="text-sky-700">æº«æ³‰ç™‚ç™’ï¼š</strong>å…¥ä½${highlightText('**å±¤é›²å³½æº«æ³‰é£¯åº—**', {}, false)}ï¼Œäº«å—æ—¥å¼è±ªè¯æœƒå¸­æ–™ç†èˆ‡å¤©ç„¶æº«æ³‰ã€‚</li>
                        <li><strong class="text-sky-700">æµªæ¼«æ•£ç­–ï¼š</strong>åœ¨${highlightText('**å°æ¨½é‹æ²³**', {}, false)}ã€${highlightText('**éŸ³æ¨‚ç›’å ‚**', {}, false)}äº«å—æµªæ¼«çš„è‡ªç”±æ™‚å…‰èˆ‡ç²¾ç·»ç”œé»ã€‚</li>
                        <li><strong class="text-sky-700">ç¾é£Ÿå¤©å ‚ï¼š</strong>ç‰¹åˆ¥å®‰æ’èŸ¹è…³æµ·é®®é™¶æ¿ç‡’ã€ä¸¦å»ºè­°é«”é©—${highlightText('**ä¸‰å¤§èŸ¹åƒåˆ°é£½**', {}, false)}ã€‚</li>
                    </ul>
                </div>
            `;
            return `
                <div class="day-content p-8 sm:p-10 bg-white rounded-xl shadow-lg border border-gray-100 space-y-8">
                    ${renderCurrentWeatherBlock()} 
                    <div>
                        <h3 class="text-2xl font-bold accent-color mb-3 border-b pb-2">âœˆï¸ èˆªç­/é›†åˆè³‡è¨Š</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium p-4 bg-gray-100 rounded-xl shadow-inner">
                            <p class="text-gray-700">å»ç¨‹ï¼š${highlightText('**è™èˆª IT 234**', {}, false)} (06:20 - 10:55) ç¬¬ä¸€èˆªå»ˆ ï½œ æ‰˜é‹ 20kg</p>
                            <p class="text-gray-700">å›ç¨‹ï¼š${highlightText('**è¯èˆª CI 131**', {}, false)} (14:40 - 18:15) èˆªå»ˆå¾…å®š ï½œ æ‰˜é‹ 2x23kg</p>
                        </div>
                    </div>
                    ${renderExchangeRateBlock()} 
                    ${highlightsContent}
                </div>
            `;
        }

        // --- è©³ç´°è¡Œç¨‹ Render (ä¿ç•™åŸè²Œï¼Œåƒ…å•Ÿå‹• highlightText çš„é»æ“ŠåŠŸèƒ½) ---
        function renderDayContent(day) {
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            const detailsHtml = `
                <h4 class="text-xl font-bold text-[#2E4057] mb-4 border-l-4 border-[#748DA6] pl-2">è¡Œç¨‹ç´°ç¯€ï¼š</h4>
                <div class="space-y-4">
                    ${day.details.map((item, index) => {
                        let durationHtml = '';
                        if (index < day.details.length - 1) {
                            const currentTime = timeToMinutes(item.time);
                            const nextTime = timeToMinutes(day.details[index + 1].time);
                            let diffMinutes = nextTime - currentTime;
                            if (diffMinutes < 0) diffMinutes += 24 * 60; 
                            const diffHours = Math.floor(diffMinutes / 60);
                            const remainingMinutes = diffMinutes % 60;
                            let durationText = '';
                            if (diffHours > 0) durationText += `${diffHours}å°æ™‚`;
                            if (remainingMinutes > 0 || diffHours === 0) durationText += `${remainingMinutes}åˆ†é˜`;
                            durationHtml = `<div class="flex flex-col items-start ml-5 sm:ml-6 mt-1 mb-1"><div class="w-0.5 h-6 bg-gray-300 ml-3"></div><div class="relative text-gray-600 px-3 py-1 text-xs font-medium flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg>é è¨ˆèŠ±è²»ï¼š${durationText}</div><div class="w-0.5 h-6 bg-gray-300 ml-3"></div></div>`;
                        }

                        const activityBlock = `
                            <div class="bg-white p-4 rounded-xl shadow border border-gray-200 transition duration-300 hover:shadow-lg flex justify-between items-start">
                                <div class="flex-grow">
                                    <p class="text-sm font-bold text-gray-500 mb-1 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-[#748DA6]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        ${item.time}
                                    </p>
                                    <p class="text-gray-800 text-base font-medium leading-normal">
                                        <!-- é€™è£¡å°‡ç¬¬ä¸‰å€‹åƒæ•¸è¨­ç‚º trueï¼Œå•Ÿç”¨é»æ“ŠåŠŸèƒ½ -->
                                        ${highlightText(item.description, item, true)}
                                    </p>
                                </div>
                                ${item.query ? `<button class="p-2 ml-4 bg-sky-500 text-white rounded-full hover:bg-sky-600 transition duration-150 shadow-md flex-shrink-0" title="åœ¨åœ°åœ–ä¸Šé–‹å•Ÿ ${item.description.replace(/<[^>]*>/g, '').replace(/\*\*/g, '')}" onclick="openInGoogleMaps('${item.query.replace(/'/g, "\\'")}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></button>` : ''}
                            </div>
                        `;
                        return activityBlock + durationHtml;
                    }).join('')}
                </div>
            `;
            
            // ä½å®¿å€å¡Šä¹Ÿä½¿ç”¨ falseï¼Œé¦–é æ¨£å¼
            const lodgingHtml = highlightText(day.lodging, {}, false);
            
            return `
                <div class="day-content p-8 sm:p-10 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-4xl font-black accent-color mb-3 border-b-2 pb-1">${day.title}</h3>
                    <p class="text-red-600 font-semibold mb-4 text-lg">${day.warning ? `âš ï¸ ${day.warning}` : ''}</p>
                    <p class="text-gray-700 mb-6 font-medium text-xl leading-relaxed">${day.subtitle}</p>
                    ${detailsHtml}
                    <div class="meal-summary p-4 mt-8 rounded-lg text-base font-semibold grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div><span class="text-[#2E4057]">ğŸ³ æ—©é¤ï¼š</span> ${day.breakfast}</div>
                        <div><span class="text-[#2E4057]">ğŸœ åˆé¤ï¼š</span> ${day.lunch}</div>
                        <div><span class="text-[#2E4057]">ğŸ¥© æ™šé¤ï¼š</span> ${day.dinner}</div>
                        <div><span class="text-[#2E4057]">ğŸ¨ ä½å®¿ï¼š</span> ${lodgingHtml}</div>
                    </div>
                </div>
            `;
        }

        // --- Tabs Logic ---
        function renderMainTabs() {
            mainTabsContainer.innerHTML = '';
            const homeButton = createMainTab('ä¸»é ', 'home', `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l-2-2m2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`);
            homeButton.onclick = () => switchMainView('home');
            mainTabsContainer.appendChild(homeButton);
            const itineraryButton = createMainTab('è©³ç´°è¡Œç¨‹', 'itinerary-group', `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M7 12h.01M6 16h.01M9 16h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`);
            itineraryButton.onclick = () => switchMainView('itinerary-group');
            mainTabsContainer.appendChild(itineraryButton);
        }
        function createMainTab(text, viewId, iconHtml) {
            const button = document.createElement('button');
            button.className = 'tab-item main-tab text-gray-700';
            button.innerHTML = iconHtml + text;
            button.setAttribute('data-view', viewId);
            return button;
        }
        function renderDayTabs() {
            dayTabsContainer.innerHTML = '';
            itineraryData.forEach(day => {
                const button = document.createElement('button');
                button.className = 'tab-item day-tab text-gray-600';
                button.textContent = `Day ${day.id}`;
                button.setAttribute('data-day-id', `day-${day.id}`);
                button.onclick = () => switchDayView(`day-${day.id}`);
                dayTabsContainer.appendChild(button);
            });
        }
        function switchMainView(viewId) {
            activeMainTab = viewId;
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-view') === viewId) tab.classList.add('active');
            });
            const baseClasses = 'content-area bg-gray-50 px-4 sm:px-6';
            if (viewId === 'home') {
                contentContainer.className = baseClasses + ' py-8 sm:py-12';
                dayTabsContainer.style.display = 'none';
                contentContainer.innerHTML = renderHomeContent();
                initializeExchangeRateStatus();
                fetchExchangeRate();
                getDynamicWeather(); 
            } else if (viewId === 'itinerary-group') {
                contentContainer.className = baseClasses + ' pt-0 pb-8 sm:pb-12';
                dayTabsContainer.style.display = 'flex';
                switchDayView(activeDayId);
            }
        }
        function switchDayView(dayId) {
            activeDayId = dayId;
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-day-id') === dayId) tab.classList.add('active');
            });
            const dayNumber = parseInt(dayId.split('-')[1]);
            const dayData = itineraryData.find(d => d.id === dayNumber);
            if (dayData) contentContainer.innerHTML = renderDayContent(dayData);
        }

        window.openInGoogleMaps = function(query) {
            if (query) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank'); 
            }
        }

        window.onload = function() {
            renderMainTabs();
            renderDayTabs();
            switchMainView('home'); 
        };
    </script>

</body>
</html>


