<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“å…­æ—¥éŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .header-bg { background-image: linear-gradient(135deg, #2E4057 0%, #748DA6 100%); }
        .accent-color { color: #0ea5e9; }
        
        .tab-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            white-space: nowrap;
            border-radius: 0;
            font-size: 0.95rem;
        }
        
        .main-tab:hover { color: #0ea5e9; border-bottom-color: #0ea5e9; }
        .main-tab.active { border-bottom-color: #0ea5e9; color: #0ea5e9; font-weight: 700; background-color: #fff; }
        
        .day-tab { color: #64748b; background-color: transparent; }
        .day-tab:hover { color: #0284c7; background-color: #f8fafc; }
        .day-tab.active { border-bottom-color: #0284c7; color: #0284c7; font-weight: 700; background-color: #f0f9ff; }

        .content-area { animation: fadeIn 0.4s ease-in-out; min-height: 500px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #location-modal { transition: opacity 0.2s ease-in-out; }
        #location-modal.hidden { opacity: 0; pointer-events: none; }
        #location-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        /* æ™‚é–“è»¸å®¹å™¨ */
        .timeline-col {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 3rem;  /* [è¨­å®š] æ™‚é–“è»¸å¯¬åº¦çª„ä¸€é»ï¼Œé å·¦ */     
            flex-shrink: 0;
        }
        
        /* å¯¦ç·š (ä¸€èˆ¬è¡Œç¨‹) */
        .timeline-line-solid {
            position: absolute;
            top: 0; 
            bottom: -3rem; 
            left: 50%; 
            width: 2px;
            transform: translateX(-50%);
            background-color: #cbd5e1; /* slate-300 */
            z-index: 0;
        }

        /* è™›ç·š (äº¤é€šè¡Œç¨‹) */
        .timeline-line-dashed {
            position: absolute;
            top: 0; 
            bottom: -3rem; 
            left: 50%; 
            width: 0;
            transform: translateX(-50%);
            border-left: 2px dashed #94a3b8; /* slate-400 */
            z-index: 0;
        }

        /* é¦–å°¾ä¿®æ­£ */
        .first-item .timeline-line-solid, .first-item .timeline-line-dashed { top: 1.5rem; }
        .last-item .timeline-line-solid, .last-item .timeline-line-dashed { bottom: auto; height: 1.5rem; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .checklist-item { cursor: pointer; transition: all 0.2s; }
        .checklist-item:hover { background-color: #f0f9ff; }
        .checklist-checkbox { accent-color: #00A8A0; width: 1.25rem; height: 1.25rem; }
        .checked-text { text-decoration: line-through; color: #9ca3af; opacity: 0.7; }
        
        .highlight-text-clickable { font-weight: 700; color: #0284c7; background-color: #e0f2fe; padding: 0 2px; border-radius: 2px; cursor: pointer; text-decoration: underline; }

        .api-key-reminder { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto bg-gray-50 shadow-2xl relative min-h-screen">
        
        <!-- Modal -->
        <div id="location-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 relative transform transition-all scale-100 border border-gray-100">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <div class="mb-5 border-b border-gray-100 pb-4 pr-8">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800 leading-tight">åœ°é»åç¨±</h3>
                    <p id="modal-jp-name" class="text-sm text-sky-600 font-medium font-['Noto_Sans_JP'] mt-1">Japanese Name</p>
                </div>
                <div class="space-y-4">
                    <div class="flex items-start"><span class="text-xl mr-3 mt-0.5 text-gray-400">ğŸ“</span><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wide">åœ°å€</p><p id="modal-address" class="text-gray-700 text-sm leading-relaxed font-medium">åœ°å€è¼‰å…¥ä¸­...</p></div></div>
                    <div class="flex items-start"><span class="text-xl mr-3 mt-0.5 text-gray-400">ğŸ•’</span><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wide">ç‡Ÿæ¥­æ™‚é–“</p><p id="modal-hours" class="text-gray-700 text-sm leading-relaxed font-medium">ç‡Ÿæ¥­æ™‚é–“è¼‰å…¥ä¸­...</p></div></div>
                    <div id="modal-ticket-row" class="flex items-start hidden"><span class="text-xl mr-3 mt-0.5 text-gray-400">ğŸ«</span><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wide">è²»ç”¨ / ç¥¨åƒ¹</p><p id="modal-ticket" class="text-orange-600 text-sm leading-relaxed font-bold">ç„¡è³‡è¨Š</p></div></div>
                    <div id="modal-aircraft-row" class="flex items-start hidden"><span class="text-xl mr-3 mt-0.5 text-gray-400">âœˆï¸</span><div><p class="text-xs font-bold text-gray-400 uppercase tracking-wide">æ©Ÿå‹</p><p id="modal-aircraft" class="text-slate-600 text-sm leading-relaxed font-bold">è¼‰å…¥ä¸­...</p></div></div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-100">
                    <button id="modal-map-btn" class="w-full bg-sky-600 text-white py-3 rounded-xl font-bold hover:bg-sky-700 transition flex items-center justify-center shadow-lg shadow-sky-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                        é–‹å•Ÿ Google Maps
                    </button>
                </div>
            </div>
        </div>

        <!-- Banner -->
        <header class="header-bg p-6 sm:p-10 text-white text-center rounded-b-xl relative shadow-md z-0">
            <h1 class="text-3xl sm:text-4xl font-extrabold opacity-95 mb-2">âœˆï¸ 2026 å†¬å­£é™å®š | åŒ—æµ·é“å…­å¤©äº”å¤œä¹‹æ—…</h1>
            <p class="text-lg font-light tracking-widest">ç ´å†°èˆ¹ï¼é›ªä¸Šæ´»å‹•ï¼å°æ¨½æ•£ç­–</p>
        </header>

        <!-- å°è¦½åˆ— Card -->
        <div class="mx-4 -mt-6 relative z-10">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                 <div id="main-tabs" class="flex overflow-x-auto whitespace-nowrap border-b border-gray-100"></div>
                 <div id="day-tabs" class="hidden overflow-x-auto whitespace-nowrap bg-slate-50/50"></div>
            </div>
        </div>

        <div id="dynamic-content" class="content-area px-4 pb-12 pt-6">
            <div class="text-center text-gray-500 py-16">è¼‰å…¥ä¸­...</div>
        </div>

        <footer class="text-center text-gray-400 text-xs py-6">
            <p>Designed for your trip.</p>
        </footer>
    </div>

    <!-- Logic -->
    <script>
        // ==========================================
        // 1. å…¨åŸŸè®Šæ•¸å®šç¾©
        // ==========================================
        const FALLBACK_RATE = 0.20; 
        let currentExchangeRate = FALLBACK_RATE; 
        let activeMainTab = 'home'; 
        let activeDayId = 'day-1';

        // ==========================================
        // 2. å‡½å¼å®šç¾©
        // ==========================================
        
        function getCategoryTag(title, desc) {
            const text = title + (desc ? " " + desc : "");
            
            // 1. å…ˆåˆ¤æ–·è³¼ç‰©
            if (text.includes("è²·") || text.includes("é€›") || text.includes("OUTLET") || text.includes("UNIQLO") || text.includes("Lawson") || text.includes("æ‰­è›‹")) return { text: "è³¼ç‰©", color: "bg-pink-400" };
            
            // 2. åˆ¤æ–·ç¾é£Ÿ (æ‹‰éºµã€ä¸¼ã€å’–å“©ã€èŸ¹ã€ä¸€å¹»ã€æ¹¯å’–å“©)
            if (text.includes("é¤") || text.includes("æ‹‰éºµ") || text.includes("ä¸¼") || text.includes("å’–å“©") || text.includes("èŸ¹") || text.includes("ä¸€å¹»")) return { text: "ç¾é£Ÿ", color: "bg-orange-400" };
            
            // 3. åˆ¤æ–·äº¤é€š (å¢åŠ æ›´å¤šäº¤é€šå‹•è©èˆ‡èˆªç©ºå…¬å¸)
            if (text.includes("JR") || text.includes("å·´å£«") || text.includes("åœ°éµ") || text.includes("å¸‚é›»") || text.includes("èˆªç­") || text.includes("äº¤é€š") || text.includes("æ­ä¹˜") || text.includes("æ­¥è¡Œ") || text.includes("è™èˆª") || text.includes("è¯èˆª")) return { text: "äº¤é€š", color: "bg-blue-400" };
            
            // 4. æœ€å¾Œåˆ¤æ–·ä½å®¿
            if (text.includes("é£¯åº—") || text.includes("ä½å®¿") || text.includes("Check-in")) return { text: "ä½å®¿", color: "bg-indigo-400" };
            
            return { text: "æ™¯é»", color: "bg-emerald-400" };
        }

        // SVG Icons
        function getCategoryIconSvg(type) {
            const icons = {
                // äº¤é€šæ”¹ç”¨æ›´å°çš„éå ´åœ–ç¤º (è»Šå­/èµ°è·¯)
                "äº¤é€š": `<svg class="w-3.5 h-3.5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>`, 
                "ç¾é£Ÿ": `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" /><path d="M7 2v20" /><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" /></svg>`,
                "ä½å®¿": `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M2 4v16" /><path d="M2 8h18a2 2 0 0 1 2 2v10" /><path d="M2 17h20" /><path d="M6 8v9" /></svg>`,
                "è³¼ç‰©": `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" /><path d="M3 6h18" /><path d="M16 10a4 4 0 0 1-8 0" /></svg>`,
                "æ™¯é»": `<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></svg>`
            };
            return icons[type] || icons["æ™¯é»"];
        }

        function toggleCheck(id) {
            const checkbox = document.getElementById(id);
            const text = document.getElementById(`text-${id}`);
            if (checkbox && text) {
                checkbox.checked = !checkbox.checked;
                if (checkbox.checked) {
                    text.classList.add('checked-text');
                } else {
                    text.classList.remove('checked-text');
                }
            }
        }

        window.openModal = function(arg1, address, hours, ticket, query, jpTitle, aircraft) {
            let data = {};
            if (typeof arg1 === 'string' && (arg1.startsWith('%7B') || arg1.startsWith('{'))) {
                try { data = JSON.parse(decodeURIComponent(arg1)); } catch (e) { data = { title: arg1 }; }
            } else {
                data = { title: arg1, address: address, hours: hours, ticket: ticket, query: query, jpName: jpTitle, aircraft: aircraft };
            }

            document.getElementById('modal-title').textContent = data.title || "è©³ç´°è³‡è¨Š";
            document.getElementById('modal-jp-name').textContent = data.jpName || ""; 
            document.getElementById('modal-address').textContent = data.address || "ç„¡è³‡è¨Š";
            document.getElementById('modal-hours').textContent = data.hours || "ä¾ç¾å ´ç‚ºæº–";
            
            const ticketRow = document.getElementById('modal-ticket-row');
            const ticketText = document.getElementById('modal-ticket');
            if (data.ticket && data.ticket !== 'undefined') {
                ticketText.textContent = data.ticket;
                ticketRow.classList.remove('hidden');
            } else {
                ticketRow.classList.add('hidden');
            }

            const aircraftRow = document.getElementById('modal-aircraft-row');
            const aircraftText = document.getElementById('modal-aircraft');
            if (data.aircraft) {
                aircraftText.textContent = data.aircraft;
                aircraftRow.classList.remove('hidden');
            } else {
                aircraftRow.classList.add('hidden');
            }

            document.getElementById('modal-map-btn').onclick = function() { 
                if(data.query) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.query)}`, '_blank'); 
            };
            document.getElementById('location-modal').classList.remove('hidden');
        };

        window.closeModal = function() { document.getElementById('location-modal').classList.add('hidden'); };
        window.openInGoogleMaps = function(query) {
            if (query) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank'); 
        }

        const highlightText = (text, item, isClickable = false) => {
            return text.replace(/\*\*(.*?)\*\*/g, (match, p1) => {
                if (isClickable && item) {
                    let data = item;
                    if (item.highlights && item.highlights[p1]) {
                        data = item.highlights[p1];
                    }
                    const safeTitle = p1.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeAddress = (data.address || item.address || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeHours = (data.hours || item.hours || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeQuery = (data.query || item.query || p1).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeJpTitle = (data.jpName || item.jpName || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeTicket = (data.ticket || item.ticket || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeAircraft = (data.aircraft || item.aircraft || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `<span class="highlight-text-clickable" onclick="openModal('${safeTitle}', '${safeAddress}', '${safeHours}', '${safeTicket}', '${safeQuery}', '${safeJpTitle}', '${safeAircraft}')">${p1}</span>`;
                } else {
                    return `<span class="font-bold text-gray-700">${p1}</span>`;
                }
            });
        };

        function initApp() {
            window.toggleCheck = toggleCheck;
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('location-modal')) closeModal();
            });

            renderMainTabs();
            renderDayTabs();
            switchMainView('home');
        }

        // --- è¡Œç¨‹è³‡æ–™ ---
        const DEFAULT_ITINERARY_DATA = [
            {
                id: 1, title: "02/20ï¼šæœ­å¹Œå•Ÿç¨‹", subtitle: "æ©Ÿå ´ç¾é£Ÿ â” å¸‚å€è£œè²¨ â” æµªæ¼«å¤œæ™¯", location: "æœ­å¹Œ, æ—¥æœ¬", 
                sunrise: "06:28", sunset: "17:12",
                jmaUrl: "https://www.jma.go.jp/bosai/forecast/#area_type=class20s&area_code=0110000",
                details: [
                    { time: "04:00", description: "**æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ** è¾¦ç†å ±åˆ°æ‰‹çºŒèˆ‡è¡Œææ‰˜é‹ã€‚", query: "æ¡ƒåœ’æ©Ÿå ´ Terminal 1", jpName: "å°æ¹¾æ¡ƒåœ’å›½éš›ç©ºæ¸¯ ç¬¬1ã‚¿ãƒ¼ãƒŸãƒŠãƒ«", address: "æ¡ƒåœ’å¸‚å¤§åœ’å€èˆªç«™å—è·¯15è™Ÿ", hours: "24å°æ™‚é–‹æ”¾" },
                    { 
                        time: "06:20", 
                        description: "æ­ä¹˜ **è™èˆª IT 234** é£›å¾€åŒ—æµ·é“æ–°åƒæ­²æ©Ÿå ´ã€‚", 
                        query: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ", jpName: "å°æ¹¾æ¡ƒåœ’å›½éš›ç©ºæ¸¯ ç¬¬1ã‚¿ãƒ¼ãƒŸãƒŠãƒ«", address: "æ¡ƒåœ’å¸‚å¤§åœ’å€èˆªç«™å—è·¯15è™Ÿ (ç¬¬ä¸€èˆªå»ˆ)", hours: "èˆªç­æ™‚é–“ä¾èˆªç©ºå…¬å¸å…¬å‘Š", flight: "é£›è¡Œæ™‚é–“ 3å°æ™‚35åˆ†", aircraft: "Airbus A320 / A320neo (å–®èµ°é“)"
                    },
                    { time: "10:55", description: "æŠµé” **åŒ—æµ·é“æ–°åƒæ­²æ©Ÿå ´**ï¼Œè¾¦ç†å…¥å¢ƒæ‰‹çºŒã€‚", query: "æ–°åƒæ­²æ©Ÿå ´", jpName: "æ–°åƒæ­³ç©ºæ¸¯", address: "æ—¥æœ¬ã€ã€’066-0012 åŒ—æµ·é“åƒæ­³å¸‚ç¾ã€…", hours: "åœ‹å…§ç·š 6:20-23:00" },
                    { time: "12:00", description: "æ­¥è¡Œè‡³åœ‹å…§ç·š 3F **åŒ—æµ·é“æ‹‰éºµé“å ´** æˆ–ç¾é£Ÿè¡—äº«ç”¨åˆé¤ (æ¨è–¦ï¼šä¸€å¹»æ‹‰éºµã€åå‹è±šä¸¼)ã€‚", query: "åŒ—æµ·é“æ‹‰éºµé“å ´", jpName: "åŒ—æµ·é“ãƒ©ãƒ¼ãƒ¡ãƒ³é“å ´", address: "æ–°åƒæ­²æ©Ÿå ´åœ‹å…§ç·šèˆªå»ˆ 3F", hours: "10:00-21:00" },
                    { 
                        time: "13:30", 
                        description: "**äº¤é€šç§»å‹•ï¼šæ–°åƒæ­²æ©Ÿå ´ â” é£¯åº—** (äºŒé¸ä¸€)\n1. **JR å¿«é€Ÿ Airport**ï¼šæ­è‡³**æœ­å¹Œç«™**ï¼Œè½‰ä¹˜ **åœ°ä¸‹éµå—åŒ—ç·š** è‡³ **ä¸­å³¶å…¬åœ’ç«™** (2è™Ÿå‡ºå£)ã€‚\n2. **æ©Ÿå ´å·´å£«**ï¼šç›´é”ä¸­å³¶å…¬åœ’ (å…æ¬è¡Œæï¼Œä½†åœ¨è·¯é¢å¯èƒ½å—é›ªæ³å½±éŸ¿)ã€‚", 
                        query: "JR æ–°åƒæ­²æ©Ÿå ´ç«™", jpName: "æ–°åƒæ­³ç©ºæ¸¯é§… / ç©ºæ¸¯é€£çµ¡ãƒã‚¹", address: "JR: B1F | å·´å£«: 1F ä¹˜è»Šè™•", hours: "JR: æ¯12åˆ†ä¸€ç­ | å·´å£«: ç´„æ¯å°æ™‚ä¸€ç­", ticket: "JR: Â¥1,150 + åœ°éµ Â¥210 | å·´å£«: Â¥1,300",
                        highlights: { 
                            "JR å¿«é€Ÿ Airport": { query: "JR æ–°åƒæ­²æ©Ÿå ´ç«™", jpName: "JR æ–°åƒæ­³ç©ºæ¸¯é§…", address: "æ–°åƒæ­²æ©Ÿå ´ B1F", hours: "æ¯ 12-15 åˆ†é˜ä¸€ç­ (æœ€å¿« 37 åˆ†)", ticket: "Â¥1,150 (éœ€è½‰ä¹˜åœ°éµ)" },
                            "æœ­å¹Œç«™": { query: "Sapporo Station", jpName: "JR æœ­å¹Œé§…", address: "åŒ—æµ·é“æœ­å¹Œå¸‚åŒ—åŒºåŒ—6æ¡è¥¿4ä¸ç›®", hours: "05:00-24:00" },
                            "åœ°ä¸‹éµå—åŒ—ç·š": { query: "Sapporo Subway Namboku Line", jpName: "æœ­å¹Œå¸‚å–¶åœ°ä¸‹é‰„å—åŒ—ç·š", address: "æœ­å¹Œç«™ â” ä¸­å³¶å…¬åœ’ç«™", hours: "ç´„ 6 åˆ†é˜ä¸€ç­", ticket: "Â¥210" },
                            "ä¸­å³¶å…¬åœ’ç«™": { query: "Nakajima Koen Station", jpName: "ä¸­å³¶å…¬åœ’é§… (N09)", address: "æœ­å¹Œå¸‚ä¸­å¤®åŒºå—9æ¡è¥¿4ä¸ç›®", hours: "06:00-24:00", ticket: "2è™Ÿå‡ºå£é›¢é£¯åº—æœ€è¿‘" },
                            "æ©Ÿå ´å·´å£«": { query: "New Chitose Airport Bus Stop", jpName: "ç©ºæ¸¯é€£çµ¡ãƒã‚¹ (ä¸­å³¶å…¬åœ’è¡Œ)", address: "åœ‹å…§ç·š 14/22 è™Ÿä¹˜è»Šè™• (ç›´é”ä¸­å³¶å…¬åœ’)", hours: "ç´„ 12:00 / 14:00 / 16:00 / 19:00 (ç­æ¬¡è¼ƒå°‘)", ticket: "Â¥1,300 / è»Šç¨‹ç´„ 80 åˆ†é˜ (å…è½‰è»Š)" }
                        }
                    },
                    { time: "15:00", description: "**Lawson** (é£¯åº—éš”å£)ï¼šè³¼è²· **é˜²æ»‘é‹å¥—** è£åœ¨é‹å­ä¸Šï¼Œé¿å…é›ªåœ°æ»‘å€’ã€‚", query: "Lawson Sapporo Nakajima Park", jpName: "ãƒ­ãƒ¼ã‚½ãƒ³ æœ­å¹Œä¸­å³¶å…¬åœ’åº—", address: "å°±åœ¨é£¯åº—è½‰è§’ (èµ°è·¯ç´„ 1 åˆ†é˜)", hours: "24å°æ™‚", ticket: "Â¥1,500 / å¿…è²·é˜²æ»‘é‹å¥—" },
                    { time: "15:10", description: "å‰å¾€ **Vessel Inn æœ­å¹Œä¸­å³¶å…¬åœ’é£¯åº—** è¾¦ç† Check-inã€‚", query: "Vessel Inn æœ­å¹Œä¸­å³¶å…¬åœ’", jpName: "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³æœ­å¹Œä¸­å³¶å…¬åœ’", address: "åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºå—ä¹æ¡è¥¿4-1-2", hours: "Check-in: 14:00" },
                    {
                        time: "15:25",
                        description: "**äº¤é€šï¼šæ­ä¹˜åœ°ä¸‹éµ** (ä¸­å³¶å…¬åœ’ â” å¤§é€šç«™)",
                        query: "Nakajima Koen Station", jpName: "åœ°ä¸‹é‰„å—åŒ—ç·š", address: "ä¸­å³¶å…¬åœ’ç«™(N09) æ­å¾€éº»ç”Ÿæ–¹å‘ â” å¤§é€šç«™(N07)ä¸‹è»Š", hours: "è»Šç¨‹ç´„ 3-4 åˆ†é˜", ticket: "Â¥210 (å¯åˆ· IC å¡)"
                    },
                    { 
                        time: "15:30", 
                        description: "å‰å¾€ **UNIQLO æœ­å¹Œ Parco åº—** æ¡è³¼ä¿æš–è¡£ç‰© (Parco 8F)ã€‚", 
                        query: "UNIQLO Sapporo Parco", jpName: "ãƒ¦ãƒ‹ã‚¯ãƒ­ æœ­å¹Œãƒ‘ãƒ«ã‚³åº—", address: "æœ­å¹Œå¸‚ä¸­å¤®å€å—1æ¢è¥¿3-3 (Parco 8F)", hours: "10:00-20:00"
                    },
                    { time: "17:00", description: "æ›ä¸Šæ–°è²·çš„ä¿æš–è¡£ç‰©ï¼Œå‰å¾€æ—é‚Šçš„ **å¤§é€šå…¬åœ’** æ•£æ­¥ï¼Œæ¬£è³é›ªæ™¯ã€‚", query: "æœ­å¹Œå¤§é€šå…¬åœ’", jpName: "å¤§é€šå…¬åœ’", address: "æœ­å¹Œå¸‚ä¸­å¤®åŒºå¤§é€šè¥¿1ï½12ä¸ç›®", hours: "å…¨å¤©é–‹æ”¾" },
                    { time: "17:30", description: "ç™»ä¸Š **æœ­å¹Œé›»è¦–å¡”** å±•æœ›å°ï¼Œä¿¯ç°æœ­å¹Œå¸‚å€å¤œæ™¯ã€‚", query: "æœ­å¹Œé›»è¦–å¡”", jpName: "ã•ã£ã½ã‚ãƒ†ãƒ¬ãƒ“å¡”", address: "æœ­å¹Œå¸‚ä¸­å¤®åŒºå¤§é€šè¥¿1ä¸ç›®", hours: "9:00 ï½ 22:00 ï¼ˆå±•æœ›æœ€çµ‚å…¥å ´ 21:50ï¼‰", ticket: "Â¥1,000" },
                    { time: "18:30", description: "è‡ªç”±é€›è¡—æ™‚é–“ï¼šå‰å¾€ **æœ­å¹Œåœ°ä¸‹è¡—** (Aurora Town/Pole Town) æˆ– Parco ç™¾è²¨ã€‚", query: "æœ­å¹Œåœ°ä¸‹è¡—", jpName: "ã•ã£ã½ã‚åœ°ä¸‹è¡—", address: "æœ­å¹Œå¸‚ä¸­å¤®åŒºå¤§é€š", hours: "10:00-20:00" },
                    { time: "19:30", description: "å‰å¾€ **#C-pla ç‹¸å°è·¯5ä¸ç›®åº—** ç›¡æƒ…æ‰­è›‹ï¼", query: "#C-pla ç‹¸å°è·¯5ä¸ç›®åº—", jpName: "#C-pla ç‹¸å°è·¯5ä¸ç›®åº—", address: "åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºå—3æ¡è¥¿5ä¸ç›®27", hours: "11:00-23:00" },
                    {
                        time: "20:15",
                        description: "**äº¤é€šï¼šæ­ä¹˜æœ­å¹Œå¸‚é›»** (ç‹¸å°è·¯ â” æ±æœ¬é¡˜å¯ºå‰)",
                        query: "Sapporo Streetcar", jpName: "æœ­å¹Œå¸‚é›» (è·¯é¢é›»è»Š)", address: "å¾ã€Œç‹¸å°è·¯ã€ç«™æ­è‡³ã€Œæ±æœ¬é¡˜å¯ºå‰ã€ç«™ (ç´„5åˆ†é˜)", hours: "ç­æ¬¡é »ç¹", ticket: "Â¥200 (å¯åˆ· IC å¡)"
                    },
                    { 
                        time: "20:30", 
                        description: "å‰å¾€ **ãˆã³ãã°ä¸€å¹» ç¸½æœ¬åº—** äº«ç”¨æ™šé¤ã€‚", 
                        query: "Ebisoba Ichigen Sohonten", jpName: "ãˆã³ãã°ä¸€å¹» ç·æœ¬åº—", address: "æœ­å¹Œå¸‚ä¸­å¤®åŒºå—7æ¡è¥¿9ä¸ç›®1024-10", hours: "11:00-03:00 (ä¸å®šä¼‘)", ticket: "Â¥1,000 / æ‹›ç‰Œï¼šé®®è¦é¹½å‘³æ‹‰éºµ"
                    },
                    {
                        time: "21:50",
                        description: "**äº¤é€šï¼šæ­¥è¡Œå›é£¯åº—** (æ•£æ­¥ç´„ 10 åˆ†é˜)",
                        query: "Vessel Inn Sapporo Nakajima Park", jpName: "å¾’æ­©ãƒ«ãƒ¼ãƒˆ (ç´„750m)", address: "å¾ä¸€å¹»æ²¿è‘—å—7æ¢é€šå¾€æ±èµ°ï¼Œé‡åˆ°å¤§é¦¬è·¯å³è½‰", hours: "ç´„ 10 åˆ†é˜", ticket: "å…è²» / æ³¨æ„ä¿æš–"
                    },
                    {
                        time: "22:00",
                        description: "æŠµé”é£¯åº—ä¼‘æ¯ï¼Œé€”ä¸­ç¶“é **Lawson** è£œçµ¦éš”å¤©æ—©é¤ã€‚",
                        query: "Vessel Inn æœ­å¹Œä¸­å³¶å…¬åœ’", jpName: "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³æœ­å¹Œä¸­å³¶å…¬åœ’", address: "å—9è¥¿4", hours: "24å°æ™‚"
                    }
                ],
                breakfast: "æº«æš–çš„å®¶ / æ©Ÿä¸Šè‡ªç†", lunch: "æ©Ÿå ´ç¾é£Ÿ (è±šä¸¼/æ¹¯å’–å“©)", dinner: "ä¸€å¹»æ‹‰éºµ ç¸½æœ¬åº—", lodging: "Vessel Innæœ­å¹Œä¸­å³¶å…¬åœ’é£¯åº—"
            },
            { id: 2, title: "02/21ï¼šæ—­å·ä¸€æ—¥éŠ", subtitle: "ä¼éµæ•£æ­¥ â” é›ªä¸Šæ¨‚åœ’ â” æº«æ³‰é£¯åº—", sunrise: "06:26", sunset: "17:14", details: [{time:"08:00", description:"å‰å¾€ **æ—­å±±å‹•ç‰©åœ’**", query:"æ—­å±±å‹•ç‰©åœ’", ticket:"Â¥1,000 / å¤§äºº"}, {time:"14:00", description:"å‰å¾€ **åŒ—æµ·é“é›ªä¸Šæ¨‚åœ’**", query:"ã´ã£ã·ã‚¹ã‚­ãƒ¼å ´"}, {time:"18:00", description:"å…¥ä½ **å±¤é›²å³½æº«æ³‰é£¯åº—**", query:"å±¤é›²å³½æº«æ³‰"}], breakfast: "æ—©é¤è‡ªç†", lunch: "ç„—çƒ¤èƒèŸ¹æµ·é®®é™¶æ¿ç‡’å¾¡è†³", dinner: "æº«æ³‰é£¯åº—è±ªè¯æ™šé¤", lodging: "**å±¤é›²å³½å‘¨é‚Šæº«æ³‰é£¯åº—**" },
            { id: 3, title: "02/22ï¼šç´‹åˆ¥ç ´å†°èˆ¹", subtitle: "æµå†°éœ‡æ’¼ â” éŠ€æ²³ç€‘å¸ƒ â” é…’é€ è¦‹å­¸", sunrise: "06:25", sunset: "17:15", details: [{time:"08:30", description:"åƒè§€ **éŠ€æ²³æµæ˜Ÿç€‘å¸ƒ**", query:"éŠ€æ²³æµæ˜Ÿç€‘å¸ƒ"}, {time:"10:30", description:"æ­ä¹˜ **ç´‹åˆ¥ç ´å†°èˆ¹** (GARINKOè™Ÿ)", query:"ç´‹åˆ¥ GARINKO è™Ÿ", ticket:"Â¥5,000 / éœ€é ç´„"}, {time:"14:30", description:"åƒè§€ **æ—­å·ç”·å±±é…’é€ **", query:"æ—­å·ç”·å±±é…’é€ "}], breakfast: "é£¯åº—å…§æ—©é¤", lunch: "è±ªè¯èŸ¹è…³å¹²è²ç«¯çˆç‡’", dinner: "æœ­å¹Œå¸‚å€è‡ªç†", lodging: "æœ­å¹Œè’™ç‰¹åˆ©åŸƒå¾·çˆ¾éœå¤«é…’åº—" },
            { id: 4, title: "02/23ï¼šå°æ¨½æµªæ¼«è¡Œ", subtitle: "é‹æ²³æ•£ç­– â” éŸ³æ¨‚ç›’å ‚ â” å¤©ç‹—å±±å¤œæ™¯", sunrise: "06:23", sunset: "17:16", details: [{time:"10:00", description:"å‰å¾€ **å°æ¨½é‹æ²³**", query:"å°æ¨½é‹æ²³"}, {time:"14:00", description:"é€› **åŒ—ä¸€ç¡å­é¤¨** èˆ‡ **éŸ³æ¨‚ç›’å ‚**", query:"å°æ¨½éŸ³æ¨‚ç›’åšç‰©é¤¨"}, {time:"16:30", description:"æ­çºœè»Šä¸Š **å¤©ç‹—å±±** çœ‹å¤œæ™¯", query:"å¤©ç‹—å±±çºœè»Š", ticket:"Â¥1,600 / ä¾†å›"}], breakfast: "æ—©é¤è‡ªç†", lunch: "å°æ¨½å£½å¸", dinner: "æ‹‰éºµå…±å’Œåœ‹", lodging: "æœ­å¹Œè’™ç‰¹åˆ©åŸƒå¾·çˆ¾éœå¤«é…’åº—" },
            { id: 5, title: "02/24ï¼šæœ­å¹Œæ·±åº¦éŠ", subtitle: "åŒ—æµ·é“ç¥å®® â” ç™½è‰²æˆ€äºº â” ä¸‰å¤§èŸ¹", sunrise: "06:21", sunset: "17:18", details: [{time:"09:00", description:"åƒæ‹œ **åŒ—æµ·é“ç¥å®®**", query:"åŒ—æµ·é“ç¥å®®"}, {time:"10:30", description:"åƒè§€ **ç™½è‰²æˆ€äººå…¬åœ’**", query:"ç™½è‰²æˆ€äººå…¬åœ’", ticket:"Â¥800 / å¤§äºº"}, {time:"19:00", description:"å¤§åƒ **ä¸‰å¤§èŸ¹åƒåˆ°é£½**", query:"æœ­å¹Œä¸‰å¤§èŸ¹åƒåˆ°é£½"}], breakfast: "æ—©é¤è‡ªç†", lunch: "Suage+ æ¹¯å’–å“©", dinner: "ä¸‰å¤§èŸ¹åƒåˆ°é£½", lodging: "æœ­å¹Œè’™ç‰¹åˆ©åŸƒå¾·çˆ¾éœå¤«é…’åº—" },
            { id: 6, title: "02/25ï¼šæ»¿è¼‰è€Œæ­¸", subtitle: "Outlet è¡€æ‹š â” æ©Ÿå ´æœ€å¾Œè¡åˆº â” æº«æš–çš„å®¶", sunrise: "06:20", sunset: "17:19", details: [{time:"10:00", description:"å‰å¾€ **ä¸‰äº• OUTLET è³¼ç‰©ä¸­å¿ƒ**", query:"æœ­å¹Œä¸‰äº•OUTLET"}, {time:"13:30", description:"æŠµé” **æ–°åƒæ­²æ©Ÿå ´** å ±åˆ°", query:"æ–°åƒæ­²æ©Ÿå ´"}, {time:"14:40", description:"æ­ä¹˜ **è¯èˆª CI 131** è¿”å°", query:"æ–°åƒæ­²æ©Ÿå ´"}], breakfast: "é£¯åº—å…§æ—©é¤", lunch: "Outlet ç¾é£Ÿè¡—", dinner: "æ©Ÿä¸Šç°¡é¤", lodging: "æº«æš–çš„å®¶" }
        ];
        let appItineraryData = [...DEFAULT_ITINERARY_DATA];
        const PREPARATION_LIST = {
            "ğŸªª é‡è¦è­‰ä»¶": [ "è­·ç…§ (æœ‰æ•ˆæœŸé™éœ€6å€‹æœˆä»¥ä¸Š)", "VJW (Visit Japan Web) QR Code æˆªåœ–", "æ—¥å¹£ç¾éˆ” (å»ºè­°å¤šæ›å°é¡ï¼Œå¦‚åƒåœ“éˆ”)", "ä¿¡ç”¨å¡ (è‹¥æœ‰äº‹å…ˆè²·JRè¦å¸¶åŒå¼µå¡)", "äº¤é€š IC å¡ (Suica/PASMO/Kitaca)", "æ—…éŠå¹³å®‰éšªä¿å–®", "å°ç£èº«åˆ†è­‰å½±æœ¬ (å‚™ç”¨)" ],
            "ğŸ”Œ é›»å­ç”¢å“": [ "ç¶²å¡/eSIM", "è¡Œå‹•é›»æº (ä½æº«è€—é›»å¿«ï¼Œå»ºè­°å¸¶2é¡†)", "å……é›»å™¨/å‚³è¼¸ç·š", "è½‰æ¥é ­ (æ—¥æœ¬ç‚ºé›™å­”æ‰æ’)", "ç›¸æ©Ÿ/åº•ç‰‡", "å–å¡é‡" ],
            "ğŸ‘• å€‹äººè¡£ç‰©": [ "æ›æ´—è¡£ç‰©", "ç¡è¡£", "é˜²é¢¨é˜²æ°´ç¾½çµ¨å¤–å¥—", "ç™¼ç†±è¡£/è¤²", "ä¸€èˆ¬é•·è¤²/åˆ·æ¯›è¤²", "é˜²æ»‘é›ªé´", "é›ªåœ°é˜²æ»‘é‹å¥—", "åšæ¯›è¥ª/ç¾Šæ¯›è¥ª", "æ¯›å¸½", "åœå·¾/è„–åœ", "é˜²æ½‘æ°´æ‰‹å¥—" ],
            "ğŸ§´ ç›¥æ´—/ä¿é¤Š": [ "åŒ–å¦å“", "ä¿é¤Šå“ (æ²¹/éœœé¡)", "å¸å¦ä¹³/æ²¹", "æ´—é¢ä¹³", "ç‰™åˆ·/ç‰™è†", "ç‰™ç·šæ£’", "æ´—/æ½¤é«®ä¹³", "é«˜ä¿æ¿•ä¹³æ¶²/è­·æ‰‹éœœ", "è­·å”‡è†", "éš±å½¢çœ¼é¡/è—¥æ°´" ],
            "ğŸ’Š å¸¸å‚™è—¥å“": [ "æ„Ÿå†’è—¥", "è…¸èƒƒè—¥", "æ­¢ç—›è—¥", "æšˆè»Šè—¥", "OKç¹ƒ/å¤–å‚·è—¥è†" ],
            "ğŸ’ å…¶ä»–å¿…å‚™": [ "å£ç½©", "é«’è¡£è¢‹", "ç©ºæ°´å£º", "æš–æš–åŒ…", "å¢¨é¡", "æ‘ºç–Šå‚˜", "è³¼ç‰©è¢‹", "è¡£ç‰©å£“ç¸®è¢‹", "æ¿•ç´™å·¾" ]
        };

        function renderMainTabs() {
            const container = document.getElementById('main-tabs');
            container.innerHTML = '';
            container.appendChild(createMainTab('ä¸»é ', 'home', `<svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l-2-2m2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 01-1 1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`));
            container.appendChild(createMainTab('è©³ç´°è¡Œç¨‹', 'itinerary-group', `<svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M7 12h.01M6 16h.01M9 16h.01M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`));
            container.appendChild(createMainTab('è¡Œå‰æº–å‚™', 'preparation', `<svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>`));
        }

        function createMainTab(text, viewId, iconHtml) {
            const button = document.createElement('button');
            button.className = 'tab-item main-tab text-gray-500';
            button.innerHTML = iconHtml + text;
            button.onclick = () => switchMainView(viewId);
            button.setAttribute('data-view', viewId);
            return button;
        }

        function renderDayTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = '';
            appItineraryData.forEach(day => {
                const button = document.createElement('button');
                button.className = 'tab-item day-tab text-gray-500'; 
                button.textContent = `Day ${day.id}`;
                button.setAttribute('data-day-id', `day-${day.id}`);
                button.onclick = () => switchDayView(`day-${day.id}`);
                container.appendChild(button);
            });
        }

        function switchMainView(viewId) {
            activeMainTab = viewId;
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active', 'border-b-2', 'border-sky-500', 'text-sky-600');
                if (tab.getAttribute('data-view') === viewId) tab.classList.add('active', 'border-b-2', 'border-sky-500', 'text-sky-600');
            });
            const contentContainer = document.getElementById('dynamic-content');
            const dayTabsContainer = document.getElementById('day-tabs');
            const baseClasses = 'content-area bg-gray-50 px-4 sm:px-6';

            if (viewId === 'home') {
                contentContainer.className = baseClasses + ' pt-2 pb-8 sm:pb-12';
                dayTabsContainer.classList.add('hidden'); dayTabsContainer.classList.remove('flex');
                contentContainer.innerHTML = renderHomeContent();
            } else if (viewId === 'itinerary-group') {
                contentContainer.className = baseClasses + ' pt-0 pb-8 sm:pb-12';
                dayTabsContainer.classList.remove('hidden'); dayTabsContainer.classList.add('flex');
                switchDayView(activeDayId);
            } else if (viewId === 'preparation') {
                contentContainer.className = baseClasses + ' pt-2 pb-8 sm:pb-12';
                dayTabsContainer.classList.add('hidden'); dayTabsContainer.classList.remove('flex');
                contentContainer.innerHTML = renderPreparationContent();
            }
        }

        function switchDayView(dayId) {
            activeDayId = dayId;
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active', 'border-b-2', 'border-sky-500', 'text-sky-600');
                if (tab.getAttribute('data-day-id') === dayId) tab.classList.add('active', 'border-b-2', 'border-sky-500', 'text-sky-600');
            });
            const dayNumber = parseInt(dayId.split('-')[1]);
            const dayData = appItineraryData.find(d => d.id === dayNumber);
            if (dayData) document.getElementById('dynamic-content').innerHTML = renderDayContent(dayData);
        }

        function convertCurrency() {
            const input = document.getElementById('jpy-input');
            const output = document.getElementById('twd-output');
            if (input && output) {
                const val = parseFloat(input.value);
                if (!isNaN(val)) {
                    output.textContent = `${Math.round(val * FALLBACK_RATE)} TWD`;
                    output.className = output.className.replace('text-gray-700', 'text-pink-700');
                } else {
                    output.textContent = '0 TWD';
                }
            }
        }

        function renderExchangeRateBlock() {
            return `<div id="exchange-rate-block" class="max-w-xs mx-auto p-2 my-2 bg-transparent">
                <p class="text-sm font-semibold text-gray-600 mb-2 text-center">ğŸ’µ JPY â‡Œ TWD å¿«é€Ÿè©¦ç®—</p>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <input type="number" id="jpy-input" 
                            oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6); convertCurrency()" 
                            placeholder="æ—¥å¹£" 
                            class="w-full py-2 px-3 border border-gray-300 rounded-lg text-sm shadow-sm focus:ring-sky-500">
                    </div>
                    <div id="twd-output" class="flex-1 flex items-center justify-end py-2 px-3 border border-gray-300 rounded-lg bg-gray-100 text-sm font-bold text-gray-700 text-right">0 TWD</div>
                </div>
                <div class="text-right text-xs text-gray-400 mt-1">åƒè€ƒåŒ¯ç‡: 0.20</div>
            </div>`;
        }

        function renderHomeContent() {
            const outboundFlight = { title: "è™èˆª IT 234", aircraft: 'Airbus A320 / A320neo (å–®èµ°é“)', query: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ", jpName: "å°æ¹¾æ¡ƒåœ’å›½éš›ç©ºæ¸¯ ç¬¬1ã‚¿ãƒ¼ãƒŸãƒŠãƒ«", address: "æ¡ƒåœ’å¸‚å¤§åœ’å€èˆªç«™å—è·¯15è™Ÿ (ç¬¬ä¸€èˆªå»ˆ)", hours: "èˆªç­æ™‚é–“ä¾èˆªç©ºå…¬å¸å…¬å‘Š" };
            const inboundFlight = { title: "è¯èˆª CI 131", aircraft: 'Boeing 777-300ER (å»£é«”å®¢æ©Ÿ)', query: "æ–°åƒæ­²æ©Ÿå ´", jpName: "æ–°åƒæ­³ç©ºæ¸¯ å›½éš›ç·šã‚¿ãƒ¼ãƒŸãƒŠãƒ«", address: "åœ‹éš›ç·šèˆªå»ˆ (æŠµé”æ¡ƒåœ’ç¬¬ä¸€èˆªå»ˆ)", hours: "èˆªç­æ™‚é–“" };

            return `
                <div class="day-content p-6 sm:p-8 bg-white rounded-xl shadow-lg border border-gray-100 space-y-6">
                    <div>
                        <h3 class="text-2xl font-bold accent-color mb-3 border-b pb-2">âœˆï¸ èˆªç­è³‡è¨Š</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm font-medium p-2">
                             <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 shadow-sm cursor-pointer hover:bg-blue-100 transition" onclick="openModal('${encodeURIComponent(JSON.stringify(outboundFlight)).replace(/'/g, "%27")}')">
                                <div class="font-bold text-lg text-[#2E4057] mb-3 flex items-center"><span class="mr-2">ğŸ›«</span> å»ç¨‹ï¼šå°åŒ— â” æœ­å¹Œ</div>
                                <div class="text-gray-700 space-y-2">
                                    <p class="flex justify-between border-b border-blue-100 pb-1"><span class="font-semibold text-gray-500">èˆªç­</span><span class="font-bold text-gray-800">è™èˆª IT 234</span></p>
                                    <p class="flex justify-between border-b border-blue-100 pb-1"><span class="font-semibold text-gray-500">æ™‚é–“</span><span>06:20 - 10:55 (3h 35m)</span></p>
                                    <p class="flex justify-between border-b border-blue-100 pb-1"><span class="font-semibold text-gray-500">èˆªå»ˆ</span><span class="font-bold text-red-600">æ¡ƒåœ’æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ (T1)</span></p>
                                    <p class="flex justify-between items-start"><span class="font-semibold text-gray-500 whitespace-nowrap mr-2">æ©Ÿå‹</span><span class="text-right text-slate-600">Airbus A320<br><span class="text-xs text-gray-400">(å–®èµ°é“)</span></span></p>
                                </div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 shadow-sm cursor-pointer hover:bg-orange-100 transition" onclick="openModal('${encodeURIComponent(JSON.stringify(inboundFlight)).replace(/'/g, "%27")}')">
                                <div class="font-bold text-lg text-[#2E4057] mb-3 flex items-center"><span class="mr-2">ğŸ›¬</span> å›ç¨‹ï¼šæœ­å¹Œ â” å°åŒ—</div>
                                <div class="text-gray-700 space-y-2">
                                    <p class="flex justify-between border-b border-orange-100 pb-1"><span class="font-semibold text-gray-500">èˆªç­</span><span class="font-bold text-gray-800">è¯èˆª CI 131</span></p>
                                    <p class="flex justify-between border-b border-orange-100 pb-1"><span class="font-semibold text-gray-500">æ™‚é–“</span><span>14:40 - 18:15 (4h 10m)</span></p>
                                    <p class="flex justify-between border-b border-orange-100 pb-1"><span class="font-semibold text-gray-500">èˆªå»ˆ</span><span class="font-bold text-red-600">æ–°åƒæ­²æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ (T1)</span></p>
                                    <p class="flex justify-between items-start"><span class="font-semibold text-gray-500 whitespace-nowrap mr-2">æ©Ÿå‹</span><span class="text-right text-slate-600">Boeing 777-300ER<br><span class="text-xs text-gray-400">(å»£é«”å®¢æ©Ÿ)</span></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${renderExchangeRateBlock()} 
                    <div>
                        <h3 class="text-2xl font-bold accent-color mb-3 border-b pb-2">ğŸ¯ è¡Œç¨‹äº®é»</h3>
                        <ul class="space-y-3 pl-4 list-disc text-gray-700">
                            <li><strong class="text-sky-700">é›ªåœ°å¥‡è§€ï¼š</strong>æ­ä¹˜ç´‹åˆ¥**ç ´å†°èˆ¹**ï¼Œè¿‘è·é›¢æ„Ÿå—é„‚éœæ¬¡å…‹æµ·çš„æµå†°éœ‡æ’¼ã€‚</li>
                            <li><strong class="text-sky-700">å‹•ç‰©æ˜æ˜Ÿï¼š</strong>å‰å¾€**æ—­å±±å‹•ç‰©åœ’**ï¼Œè§€è³å†¬å­£é™å®šçš„ä¼éµé›ªåœ°æ•£æ­¥ã€‚</li>
                            <li><strong class="text-sky-700">æº«æ³‰ç™‚ç™’ï¼š</strong>å…¥ä½**å±¤é›²å³½æº«æ³‰é£¯åº—**ï¼Œäº«å—æ—¥å¼è±ªè¯æœƒå¸­æ–™ç†èˆ‡å¤©ç„¶æº«æ³‰ã€‚</li>
                            <li><strong class="text-sky-700">ç¾é£Ÿå¤©å ‚ï¼š</strong>é«”é©—**ä¸‰å¤§èŸ¹åƒåˆ°é£½**ã€æ¹¯å’–å“©ã€ä¸€å¹»æ‹‰éºµç­‰åŒ—æµ·é“å¿…åƒç¾é£Ÿã€‚</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderPreparationContent() {
            let html = `
                <div class="day-content p-6 sm:p-8 bg-white rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-2xl font-black accent-color mb-3 border-b-2 pb-1">ğŸ’ è¡Œå‰æº–å‚™æ¸…å–®</h3>
                    <p class="text-gray-600 mb-6 text-lg">é‡å° 2 æœˆåŒ—æµ·é“é›ªå­£å„ªåŒ–ï¼Œè«‹å‹™å¿…ç¢ºèªä»¥ä¸‹ç‰©å“æ˜¯å¦å‚™é½Šã€‚</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            `;
            let catIndex = 0;
            for (const category in PREPARATION_LIST) {
                html += `
                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                        <h4 class="font-bold text-xl text-sky-800 mb-3 pb-2 border-b border-gray-300">${category}</h4>
                        <ul class="space-y-2">
                `;
                PREPARATION_LIST[category].forEach((item, index) => {
                    const uniqueId = `prep-item-${catIndex}-${index}`;
                    html += `
                        <li class="checklist-item flex items-start" onclick="toggleCheck('${uniqueId}')">
                            <input type="checkbox" id="${uniqueId}" class="checklist-checkbox mt-1 mr-3 flex-shrink-0 cursor-pointer pointer-events-none">
                            <span id="text-${uniqueId}" class="text-gray-700 font-medium leading-relaxed">${item}</span>
                        </li>
                    `;
                });
                html += `</ul></div>`;
                catIndex++;
            }
            html += `</div></div>`;
            return html;
        }

        // --- Render Day Content (Updated for Hybrid Timeline Style) ---
        function renderDayContent(day) {
            const detailsHtml = day.details.map((item, index) => {
                let title = "";
                let desc = item.description;
                const boldMatch = item.description.match(/\*\*(.*?)\*\*/);
                if (boldMatch) {
                    title = boldMatch[1];
                    desc = item.description.replace(/\*\*.*?\*\*/, "").trim(); 
                } else {
                    title = item.description.split("ï¼Œ")[0];
                }

                const tag = getCategoryTag(title, item.description); // [Updated] Pass title and desc
                const isTraffic = tag.text === "äº¤é€š"; 

                // SVG Icons
                const iconSvg = isTraffic 
                    ? `<svg class="w-3.5 h-3.5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>` 
                    : getCategoryIconSvg(tag.text);

                // Colors
                const iconBgColors = { "ç¾é£Ÿ": "bg-orange-400", "ä½å®¿": "bg-indigo-400", "è³¼ç‰©": "bg-pink-400", "æ™¯é»": "bg-emerald-400" };
                const iconBg = isTraffic ? "bg-white border-2 border-slate-300" : (iconBgColors[tag.text] || "bg-gray-400");

                // Timeline Line Style (è™›ç·š vs å¯¦ç·š)
                const lineClass = isTraffic ? "timeline-line-dashed" : "timeline-line-solid";

                let itemData = { ...item };
                if (item.highlights && item.highlights[title]) {
                     Object.assign(itemData, item.highlights[title]);
                } else if(item.highlights) {
                     const highlightKey = Object.keys(item.highlights).find(key => title.includes(key) || item.description.includes(key));
                     if(highlightKey) Object.assign(itemData, item.highlights[highlightKey]);
                }
                
                const dataStr = encodeURIComponent(JSON.stringify(itemData)).replace(/'/g, "%27");
                const lastItemClass = index === day.details.length - 1 ? 'last-item' : '';
                const firstItemClass = index === 0 ? 'first-item' : '';

                // Extract Price
                let priceDisplay = "";
                let infoText = "";
                if (itemData.ticket) {
                    if (itemData.ticket.includes("Â¥")) {
                         const parts = itemData.ticket.split(/[\/|]/);
                         priceDisplay = parts[0].trim();
                         if (parts.length > 1) infoText = parts.slice(1).join(" ").trim();
                    } else {
                        infoText = itemData.ticket;
                    }
                }
                
                if (itemData.flight) {
                    infoText = infoText ? `${infoText} â€¢ ${itemData.flight}` : itemData.flight;
                }

                // è™•ç†å¤šè¡Œæè¿° (ä¾‹å¦‚äº¤é€šäºŒé¸ä¸€)
                const descHtml = desc.split('\n').map((line, i) => {
                    return i === 0 ? highlightText(line, item, true) : `<span class="block mt-1 text-slate-500 pl-4 border-l-2 border-slate-200 text-xs">${highlightText(line, item, true)}</span>`;
                }).join('');

                if (isTraffic) {
                    // [äº¤é€š/ç§»å‹•æ¨£å¼] - è™›ç·šéå ´ï¼Œç°¡å–®æ–‡å­—ï¼Œé»æ¨™é¡Œå¯çœ‹è©³æƒ…
                    // [èª¿æ•´] gap-4 -> gap-3ï¼Œè®“å…§å®¹æ›´é è¿‘æ™‚é–“è»¸
                    return `
                    <div class="flex gap-3 relative pb-6 ${lastItemClass} ${firstItemClass}">
                        <div class="timeline-col"> 
                             <div class="${lineClass}"></div>
                             <div class="w-7 h-7 rounded-full ${iconBg} flex items-center justify-center shadow-sm z-10 relative mt-1">
                                ${iconSvg}
                             </div>
                        </div>
                        <div class="flex-grow py-1">
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-1">
                                <span class="text-slate-500 font-bold font-['Noto_Sans_JP'] text-sm tracking-wide bg-slate-100 px-2 py-0.5 rounded w-fit">${item.time}</span>
                                <h4 class="text-base font-bold text-slate-600 leading-snug cursor-pointer hover:text-sky-600 hover:underline" onclick="openModal('${dataStr}')">${title}</h4>
                                ${priceDisplay ? `<span class="bg-gray-100 text-gray-500 text-xs font-bold px-1.5 py-0.5 rounded border border-gray-200">${priceDisplay}</span>` : ''}
                            </div>
                            <div class="text-xs text-slate-500 leading-relaxed pl-1 border-l-2 border-slate-200 ml-1">
                                ${descHtml}
                            </div>
                            ${infoText ? `<p class="text-[10px] text-yellow-600 mt-1 pl-2 font-medium">ğŸ’¡ ${infoText}</p>` : ''}
                        </div>
                    </div>
                    `;
                } else {
                    // [ä¸€èˆ¬æ¨£å¼] - ç™½è‰²å¡ç‰‡ï¼Œå¯¦ç·š
                    // [èª¿æ•´] gap-4 -> gap-3
                    return `
                    <div class="flex gap-3 relative pb-8 ${lastItemClass} ${firstItemClass}">
                        <div class="timeline-col"> 
                             <div class="timeline-line-solid"></div>
                             <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center text-white shadow-md z-10 relative mt-1">
                                ${iconSvg}
                             </div>
                        </div>
                        <div class="flex-grow bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all relative">
                            <div class="flex justify-between items-start mb-2">
                                <!-- [ä¿®æ­£] å°‡ text-blue-600 æ”¹ç‚º text-slate-500ï¼Œèˆ‡äº¤é€šè¡Œç¨‹çš„æ™‚é–“é¡è‰²çµ±ä¸€ -->
                                <span class="text-slate-500 font-bold font-['Noto_Sans_JP'] text-sm tracking-wide bg-slate-100 px-2 py-0.5 rounded">${item.time}</span>
                                ${priceDisplay ? `<span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded border border-gray-200">${priceDisplay}</span>` : '' }
                            </div>
                            <h4 class="text-lg font-bold text-sky-600 mb-1 leading-snug cursor-pointer hover:underline" onclick="openModal('${dataStr}')">${title}</h4>
                            <p class="text-sm text-gray-600 mb-3 leading-relaxed">${highlightText(desc, item, true)}</p>
                            ${infoText ? `<div class="bg-yellow-50 border border-yellow-100 text-yellow-800 text-xs p-2.5 rounded-lg mb-3 flex items-start"><span class="mr-1.5 text-sm">ğŸ’¡</span><span class="mt-0.5 leading-snug">${infoText}</span></div>` : ''}
                            <div class="text-sky-500 text-xs font-bold flex items-center hover:text-sky-600 mt-auto pt-2 border-t border-gray-50 cursor-pointer w-fit" onclick="event.stopPropagation(); openInGoogleMaps('${itemData.query}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                åœ°åœ–å°èˆª
                            </div>
                        </div>
                    </div>
                    `;
                }
            }).join('');

            return `
                <div class="w-full px-1"> <!-- [èª¿æ•´] ç§»é™¤ max-w-3xl å’Œ mx-autoï¼Œæ”¹ç‚º w-fullï¼Œè®“å€å¡Šè®Šå¤§ -->
                    <div class="mb-6 pl-2">
                        <h2 class="text-2xl font-black text-slate-800 mb-2">${day.title}</h2>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                            <p class="text-gray-600 font-medium text-lg">${day.subtitle}</p>
                             ${day.sunrise ? `
                                <div class="inline-flex items-center gap-3 text-xs font-semibold text-slate-500 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100 w-fit">
                                    <span class="flex items-center"><span class="text-orange-500 mr-1">ğŸŒ…</span>${day.sunrise}</span>
                                    <div class="h-3 w-[1px] bg-slate-300"></div>
                                    <span class="flex items-center"><span class="text-indigo-500 mr-1">ğŸŒ‡</span>${day.sunset}</span>
                                </div>
                            ` : ''}
                        </div>
                         ${day.jmaUrl ? `
                            <a href="${day.jmaUrl}" target="_blank" class="mt-3 inline-flex items-center text-xs font-bold text-sky-600 bg-sky-50 hover:bg-sky-100 px-3 py-1.5 rounded-full transition-colors border border-sky-100 w-fit">
                                ğŸŒ¤ï¸ å¤©æ°£é å ± (æ—¥æœ¬æ°£è±¡å»³)
                            </a>
                        ` : ''}
                         ${day.warning ? `
                            <div class="mt-4 bg-red-50 border-l-4 border-red-400 p-3 rounded-r-lg">
                                <p class="text-red-700 text-sm font-bold flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    ${day.warning}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="relative pt-2 pl-2">
                        ${detailsHtml}
                    </div>
                    <div class="mt-8 bg-slate-100 rounded-xl p-5 border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Day Summary</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-2 gap-x-4 text-sm">
                            <div class="flex"><span class="w-12 text-slate-500 font-medium">æ—©é¤</span> <span class="text-slate-800 font-medium">${day.breakfast}</span></div>
                            <div class="flex"><span class="w-12 text-slate-500 font-medium">åˆé¤</span> <span class="text-slate-800 font-medium">${day.lunch}</span></div>
                            <div class="flex"><span class="w-12 text-slate-500 font-medium">æ™šé¤</span> <span class="text-slate-800 font-medium">${day.dinner}</span></div>
                            <div class="flex items-start"><span class="w-12 text-slate-500 font-medium flex-shrink-0">ä½å®¿</span> <span class="text-slate-800 font-bold text-sky-700">${day.lodging.replace(/\*\*/g, '')}</span></div>
                        </div>
                    </div>
                    <div class="h-12"></div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
    </script>
</body>
</html>